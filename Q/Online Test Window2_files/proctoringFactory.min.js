define2(["services/proctoring/proctoringMessageProcessingService","services/proctoring/proctoringDataService","constants/proctoringConstants","services/testWindowConstants"],function(){angular.module("mettl").register.factory("ProctoringFactory",["$rootScope","$q","$log","$window","$timeout","$proctor","ProctoringMessageProcessingService","ProctoringConstants","TestWindowConstants","ProctoringDataService",function(v,w,g,x,t,b,h,k,m,e){function f(a,n,d,c){a=l(a,n,d,c);g.log("sending chat message to server.Chat type:"+
a.chatType);b.sendMessage(a)}function l(a,b,d,c){a={chatType:a,message:b,to:d};c&&(a.metaData=c);return a}function u(a){this.name=a.name;this.email=a.email;this.id=a.id;this.clientId=a.clientId;this.isTestPaused=!1;this.scheduleKey=a.scheduleKey;this.isWebProctored=a.isWebProctored;this.assessmentId=a.assessmentId;this.type=a.type;this.isSystemCheck=a.isSystemCheck;this.isApi=a.isApi;this.checkSuspiciousSoftware=a.checkSuspiciousSoftware;this.isRunningWebRTC=a.isRunningWebRTC;this.testState=k.TestState.NOT_STARTED;
this.isDiagnostics=!1;this.userId="0_"+a.id;this.hasScreens=a.hasScreens;this.groupId=a.groupId;this.uniqueId=a.uniqueId;this.mpsClientId=a.mpsClientId;this.isMpsCandidate=!1;this.mappedProctorData=a.mappedProctorData}function r(a,b){t(function(){g.log("Reconnecting with proctoring servers."+b);var c=e.getAuthToken();a(c)},k.Constants.AUTO_RECONNECT_TRIAL_TIMEOUT)}var c=k.ChatMessageType,p=m.Url.proctoringAuthUrl,q=m.Url.websocketServerUrl,s=m.Url.streamingServerUrl;return{startTest:function(a,n,
d){e.setTestState(k.TestState.TEST_STARTED);e.setTestPaused(a);b.updateAuthToken(e.getAuthToken());g.log("sending test start chat message to server");a=l(c.TEST_STARTED,a,null,d);b.sendStartTestMessage(a,n)},sendAuthorizationRequest:function(a){g.log("sending authorization request to server");e.setTestState(k.TestState.UNAUTHORIZED);f(c.AUTH_REQUEST,JSON.stringify(a))},sendCandidateImageRequest:function(a){f(c.REF_IMAGE,JSON.stringify(a))},startCommunication:function(a,c){var d=new u(c),f={authToken:d,
callbackUrlForClose:h.onDisconnection,callbackUrlForOpen:h.onOpen,webSocketServerUrl:q,webSocketAuthUrl:p,streamingServerUrl:s,callbackUrlForMessage:h.processMessage,candidate:c,isAuthorization:a,retrialCount:0};e.setAuthToken(d);return b.startCommunication(f)},setRetrialCount:b.setRetrialCount,getWebRTCPreferences:b.getWebRTCPreferences,sendWebRTCPreference:function(a){f(c.WEBRTC_PREFERENCES,JSON.stringify(a))},getLocalVideoDeviceName:b.getLocalVideoDeviceName,sendRegularImage:b.sendRegularImage,
shutdownMediaFlow:b.shutdown,shutdownCommunication:b.shutdown,shutdownProctoring:b.shutdownProctoring,startPresenterStream:b.startPresenterStream,startCandidateProctoring:b.startCandidateProctoring,testFinished:function(){var a=l(c.CANDIDATE_TEST_FINISHED);b.finishTest(a)},startVideoStreamByIndex:b.startVideoStreamByIndex,resumeDiagnosticsAfterCameraSelection:b.resumeDiagnosticsAfterCameraSelection,checkAppletSettingAndResumeDiagnosticsAfterCameraSelection:b.checkAppletSettingAndResumeDiagnosticsAfterCameraSelection,
reconnectAuthRequest:function(){r(b.reconnectAuthRequest)},reconnect:function(a){r(b.reconnect,a)},informCandidateBlurAway:function(){b.speedupScreenCapture(!0)},informCandidateBlurIn:function(){b.normalizeRegularScreenCaptureSpeed(!1)},sendWebRTCRecordingURL:function(a){f(c.WebRTC_RECORDING_URL,a)},acknowledgePause:function(a){a=l(c.PAUSE_ACK,"",a);b.sendAck(a)},acknowledgeResume:function(a){a=l(c.RESUME_ACK,"",a);b.sendAck(a)},sendChatMessage:function(a){f(c.MESSAGE,a)},getWebcamInfo:b.getWebcamInfo,
captureWebcamImage:b.captureWebcamImage,startSelfStreaming:b.startSelfStreaming,takeFaceSnap:b.takeFaceSnap,takeIdSnap:b.takeIdSnap,releaseWebCam:b.releaseWebCam,hideStream:b.hideStream,showStream:b.showStream,sendWebCamChanged:b.sendWebCamChanged,sendFinalWebCamSelected:b.sendFinalWebCamSelected,recheckSystemSoftware:b.recheckSystemSoftware,raiseChromePluginError:function(){appletMethodsCallStack.push(["chromePluginFound",[]])},setBlockedSoftares:function(a){MessageProcessingService.setBlockedSoftares(JSON.stringify(a))},
runDiagnostics:function(a,c,d,f){var e=parseInt(1E6*Math.random()),g=parseInt(1E6*Math.random());return b.runDiagnostics({authToken:{isRunningWebRTC:!1,clientId:a.clientId||"9506",type:0,isApi:!1,testState:0,isDiagnostics:!0,scheduleKey:a.key||"b71d6464",isTestPaused:!1,name:"diagnostics",id:e,userId:"0_"+e,isWebProctored:!1,assessmentId:a.assessmentId||g,checkSuspiciousSoftware:!1,email:a.candidateEmailId||"diagnostics@mettl.com",hasScreens:d,groupId:g,uniqueId:e,isMpsCandidate:!1,mpsClientId:"1"},
webSocketServerUrl:q,callbackUrlForMessage:h.processMessage,webSocketAuthUrl:p,checkAudio:!a.proctoringSettings.audioOptional,streamingServerUrl:s,autoClose:!0,checkTurnServerAccess:!0,checkScreens:d,disableMediaPermissionTimeOut:c,isCheckWebRTC:!0,screenPluginId:f})},runAppletDiagnostics:function(a){g.log("diagnostics data",a);a.isAppletBased=!0;a.webSocketServerUrl=q;a.webSocketAuthUrl=p;a.callbackUrlForMessage=h.processMessage;a.appletDownloadUrl=m.Url.candidateAppletDownloadUrl;return b.runDiagnostics(a)},
logEvents:function(a){f(c.CANDIDATE_EVENT,JSON.stringify(a))},stopPresenterStreaming:b.stopPresenterStreaming,setMaxRetries:b.setMaxRetries,installBrowserPlugin:b.installBrowserPlugin,updateBrowserPlugin:b.updateBrowserPlugin,startWebRTCAndSetVideoElem:b.startWebRTCAndSetVideoElem,init:b.init}}])});