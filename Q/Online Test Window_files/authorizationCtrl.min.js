define2("services/registrationService services/testWindowConstants ../constants/proctoringConstants services/authorizationService services/authorizationDataService directives/chatDirective services/testWindowTestStateService services/testWindowFactory services/testWindowHelperService services/testWindowCommonUtils controllers/appletErrorCtrl services/proctoring/proctoringProviderFactory services/proctoring/proctoringFactory services/errorLogService".split(" "),function(){angular.module("mettl").register.controller("AuthorizationCtrl",
["$scope","$log","$state","$timeout","$window","$q","$http","$controller","$sce","TestWindowConstants","ProctoringConstants","AuthorizationService","AuthorizationDataService","TestWindowFactory","TestWindowHelperService","TestWindowCommonUtils","ProctoringProviderFactory","ProctoringFactory","ErrorLogService",function(a,d,m,l,Q,w,E,F,G,s,h,n,f,x,H,r,t,R,I){function J(){F("AppletErrorCtrl",{$scope:a});a.opts.waitToResume?m.go(s.Url.resumePageUrl):(a.opts.isApi&&(a.regStepNo=0),a.opts.proctoringSettings=
a.opts.proctoringSettings||{authorization:!1,screenCapture:!1},p=a.opts.proctoringSettings.authorization,a.isCandidateRunningWebRTC=f.isCandidateRunningWebRTC(),t.init(a.opts.advancedProctoring,a.isCandidateRunningWebRTC).then(function(){I.log("Candidate test running info. ciid: "+f.getCandidateId()+" , proctoring mode: "+n.getProctoringModeEnum(a.opts.onAppletFallback,a.isCandidateRunningWebRTC)+" , client id : "+a.opts.clientId+" , schedule key is: "+a.opts.key,!0);u=t.getCommunicationProvider();
e=t.getMediaProvider();K()}))}function L(){var b=w.defer();if(-1<[h.AuthorizationRequestType.REAUTHORIZATION,h.AuthorizationRequestType.NEW].indexOf(a.candidateInfo.requestType))M().then(b.resolve,b.reject);else{var c=f.getMpsCandidateInfo();l(function(){b.resolve(c)},10)}return b.promise}function M(){var b=w.defer(),c={userMetaData:f.getCrfsRequired(),proctoringSettings:a.opts.proctoringSettings,userId:f.getCandidateId(),groupName:a.opts.originalTestName,parentGroupId:a.opts.clientId};E({method:"post",
url:s.Url.generateProctoringAuthToken,data:angular.toJson(c),timeout:1E4}).success(function(a,c,d,g){a.success?(a=a.user,c={id:a.id,groupId:a.groupId,mpsClientId:a.clientId},f.updateMpsCandidateInfo(c),x.test.updateMpsCandidateInfo(c),b.resolve(a)):b.reject()}).error(function(a,c,f,g){d.log("error occurred while generating auth token");b.reject()});return b.promise}function K(){n.initAuthorization(p,a.isCandidateRunningWebRTC,u).then(function(b){a.candidateInfo=b.candidateInfo;a.viewOptions=b.viewOptions;
a.authQueueInfo=b.authQueueInfo;a.resubmitPendingFields=b.resubmitPendingFields;a.onlineAdmins=f.getOnlineAdmins();b.candidateInfo.authRequestState==k.BLOCKED?y(b.candidateInfo.requestResponse.comments):b.isResubmit?z():b.isReAuthorization&&(a.candidateInfo.requestType=h.AuthorizationRequestType.REAUTHORIZATION);b.startFaceStreaming&&A()},function(a){d.log(a);a.exception&&(d.error("redirecting to diagnostics",a),m.go("diagnostics"));500==a.status&&(d.error("redirecting to error page",a),m.go("error"))})}
function B(){a.showSelfStream=!1;if(a.isCandidateRunningWebRTC){var b=document.getElementById("webRTCWebcam");b&&(b.onended=angular.noop)}e.hideStream()}function N(){d.info("Detected loss of WebRTC stream");a.$broadcast(g.CAMERA_UNAVAILABLE)}function A(){a.isCandidateRunningWebRTC&&(a.showSelfStream=!0);l(function(){e.startSelfStreaming(document.getElementById("webRTCWebcam"))},10)}function O(){a.isCandidateRunningWebRTC&&(a.showSelfStream=!0);l(function(){e.startSelfStreaming(document.getElementById("webRTCWebcam"))},
10)}function y(b){b=unescape(b);q();a.candidateInfo.authRequestState=k.BLOCKED;d.log("request has been blocked:"+b);a.blockComments=b;u.shutdownCommunication();e.shutdownMediaFlow();r.syncParent("authorizationDenied")}function q(){a.onlineAdmins={};f.setOnlineAdmins(a.onlineAdmins)}function C(b,c){a.onlineAdmins[b]||(a.onlineAdmins[b]={from:b,name:c},f.setOnlineAdmins(a.onlineAdmins))}function D(){var b=!1;x.load(a.opts).then(function(){b=!0;m.go(s.Url.startTestUrl)},function(a){d.error("Error in load test",
a);v()});l(function(){b||v()},3E5)}function v(){P.ShowNetworkDisconnectionBeforeST(function(){window.location.reload()})}function z(){var b=f.getAuthorizationResponse();a.resubmitPendingFields=b.data;a.resubmitPendingFields.comment=b.comments;a.candidateInfo.authRequestState=k.PENDING;a.candidateInfo.requestType=h.AuthorizationRequestType.RESUBMIT;a.resubmitPendingFields.faceImage?(a.viewOptions.isCaptureSnapImage=!0,a.viewOptions.isWebCamFeed=!0,l(function(){e.startSelfStreaming(document.getElementById("webRTCWebcam"))},
10)):a.resubmitPendingFields.idImage?(a.viewOptions.isCaptureSnapImage=!1,a.viewOptions.isWebCamFeed=!0,l(function(){e.startSelfStreaming(document.getElementById("webRTCWebcam"))},10)):(d.log("Resubmit flow completed, sending this request"),a.submitRequest())}if(a.$parent.initialised){var g=h.AppletMessageType,k=h.AuthorizationRequestState,P=H.Dialogue;a.isCandidateRunningWebRTC=!1;a.AuthRequestState=k;a.regStepNo=1;a.isConnected=!0;var u,e,p=!1;a.duplicateUserDetected=!1;a.$on(g.STREAMING_FOR_IMAGE_READY,
function(b,c){l(function(){if(a.isCandidateRunningWebRTC){a.showSelfStream=!0;document.getElementById("webRTCWebcam").onended=N;var b=document.getElementById("webRTCWebcam");"undefined"!==typeof b&&null!=b&&(b.muted=!0)}else e.showStream("appletFrame");a.enableButtonToCapture=!0},10)});a.$on(g.SHOW_FACE_IMAGE,function(b,c){d.log("showing face image here");B();a.candidateInfo.candidateImage=c;a.viewOptions.isWebCamFeed=!1});a.$on(g.SHOW_ID_IMAGE,function(b,c){d.log("showing face image here");B();a.candidateInfo.candidateIdImage=
c;a.viewOptions.isWebCamFeed=!1});a.$on(g.REGISTRATION_FIELD_ACK,function(b,c){a.$apply(function(){p?a.candidateInfo.authRequestState=k.ACKNOWLEDGED:D()})});a.$on(g.PENDING_AUTHORIZATION_COUNT,function(b,c){k.ACKNOWLEDGED==a.candidateInfo.authRequestState&&a.$apply(function(){d.log("Auth queue json is:"+c);var b=angular.fromJson(c);a.authQueueInfo={anyAdmin:b.isAdminFound,queueCount:b.currPos};0<b.currPos&&q()})});a.$on(g.CANDIDATE_AUTH_PROCESSED,function(b,c){a.$apply(function(){var b=c.from,g=c.metaData,
e=angular.fromJson(c.message);d.log("Processing admin response",e);f.setAuthorizationResponse(e);f.setAdminData(b,g);switch(e.updateType){case h.AuthRequestProcessedType.APPROVED:q();D();r.syncParent("authorizedToTest");break;case h.AuthRequestProcessedType.BLOCKED:y(e.comments);break;case h.AuthRequestProcessedType.RESUBMIT_REQUESTED:a.candidateInfo.authRequestState=k.RESUBMIT_REQUESTED;d.log("resubmit requested.",e);r.syncParent("refillRegistration");b=f.getAdminData();C(b.id,b.name);break;default:d.warn("Invalid response from admin",
e)}})});a.$on(g.MESSAGE,function(b,c){var d=c.metaData||JSON.parse(c.message).userName;a.$apply(function(){C(c.from,d)})});a.$on(g.OFFLINE,function(b,c){d.log("offline received of:",c);a.$apply(function(){a.onlineAdmins[c.from]&&(delete a.onlineAdmins[c.from],f.setOnlineAdmins(a.onlineAdmins))})});a.$on(g.SELF_OFFLINE,function(b,c){d.debug("Disconnected from servers");a.isConnected=!1;q();n.reconnect()});a.$on(g.SELF_ONLINE,function(b,c){d.debug("Connected with servers");a.isConnected?d.debug("Already connected with servers"):
(a.isConnected=!0,n.resendAuthRequest(a.opts.visualProctoring&&!a.opts.onAppletFallback||a.isCandidateRunningWebRTC,p,a.candidateInfo))});a.$on(g.DUPLICATE_USER,function(b,c){n.shutdownCommunication();a.duplicateUserDetected=!0;a.isConnected=!1});a.trustSrc=function(a){return G.trustAsResourceUrl(a)};a.captureImage=function(b){b?e.takeFaceSnap():e.takeIdSnap();a.enableButtonToCapture=!1};a.recaptureImage=function(){a.viewOptions.isWebCamFeed=!0;A()};a.showIdCapture=function(){a.viewOptions.isCaptureSnapImage=
!1;a.viewOptions.isWebCamFeed=!0;a.resubmitPendingFields.faceImage=!1;O()};a.submitRequest=function(){a.authQueueInfo={};a.candidateInfo.authRequestState=k.SUBMITTED;a.resubmitPendingFields.faceImage=!1;a.resubmitPendingFields.idImage=!1;L().then(function(b){a.candidateInfo.id=b.id;a.candidateInfo.groupId=b.groupId;a.candidateInfo.mpsClientId=b.mpsClientId;n.submitRequest(p,a.candidateInfo.requestType,a.candidateInfo.candidateImage,a.candidateInfo.candidateIdImage)},function(a){v()});r.syncParent("waitingForAuthorization");
q()};a.startResubmitSteps=function(){var a=f.getAuthorizationResponse();a.data.crfs&&0<a.data.crfs.length?m.go("registration"):z()};J()}else d.log("redirecting to diagnostics"),m.go("diagnostics")}])});