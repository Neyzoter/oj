define2("services/testWindowConstants services/testWindowTimerService services/testWindowHelperService services/testWindowTestStateService services/testWindowFactory services/testWindowQuestionService services/navigationControlService".split(" "),function(){angular.module("mettl").register.service("TestWindowSectionService",["$rootScope","$q","$timeout","TestWindowConstants","TestWindowTestStateService","TestWindowHelperService","TestWindowTimerService","TestWindowFactory","TestWindowQuestionService",
"$log","NavigationControlService",function(l,p,x,f,b,g,h,m,y,r,z){function s(a){t(a);y.endItem(a.CurrentItem,h.GetTestTime());if(a.IsTimed){var b=h.GetTestTime(),b=b-h.GetSectionTime();h.UpdateTime({time:b,test:!0});h.Kill({section:!0});a.Status=f.Status.Completed}}function u(a){m.sections.getByIndex(a).Status=f.Status.Completed;l.$emit(f.Events.Server.PRSync,"Section Time Over for "+b.sectionState.currentIndex);for(var d=b.sectionState.current.SectionName,c=void 0,e=0;e<m.sections.count();e++){var g=
m.sections.getByIndex(e);g.Status!=f.Status.Completed&&g!=b.sectionState.current&&void 0===c&&(c=g.Index)}if(void 0!==c){var n=cn.neyzoter.test.isFixedSectionOrder(),q;z.isNavigationAllowed(f.NavigationAway.SECTION_TIME_OUT).then(function(e){var g="";e&&e[0]&&(g=e[0].isPresentQuestion?e[0].extraMessage:"");if(n){e=m.sections.getByIndex(c);var p=FIXED_SECTION_OVER_MESSAGE||"\x3cp\x3eRedirecting you to \x3cb\x3e {0}\x3c/b\x3e \x3c/p\x3e \x3cp\x3e (Section {1} of {2}) in \x3cspan id\x3d'section-timer'\x3e\x3c/span\x3e seconds\x3c/p\x3e";
q=String.format(p+g,e.SectionName,c+1,m.sections.getAll().length)}else g={sections:m.sections.getAll(),isSectionTimeOverAndResumed:b.testState.isSectionTimeOverAndResumed,isCurrent:b.sectionState.current,completedStatus:f.Status.Completed,defaultNextSectionIndex:c,extraMessage:g},q=k.GetTemplate("section-time-over-template",g);h.Stop();b.sectionState.sectionChangeTransition.set(a,!0);b.sectionState.timedOut.set(a,!0);g=[RR_START_SECTION];b.testState.isSectionTimeOverAndResumed&&(g=[]);k.Show({title:TEST_SECTION_TIME_OVER+
" "+d,message:q,type:k.Type.SECTION_SELECTOR,priority:k.Priority.SECTION_SELECTOR,actions:g,call:"SectionOver",callback:function(a){var e=$("#section-timer"),d=c;n||(d=parseInt(e.parents(".modal").find(":checked").attr("index")));e.tickTock("destroy");k.Hide();r.log("Section HIDE Callback with index \x3e ",d);b.itemState.currentIndex=0;A(parseInt(d,10));"object"==typeof a&&a.toStopTimer&&x(function(){l.$broadcast(f.Events.Test.PauseTest,{})},500)}})})["catch"](function(a){r.error("Navigation not allowed in case of section time out. Error: ",
a)})}}function A(a){h.Kill({section:!0});b.testState.isSectionTimeOverAndResumed=!1;b.sectionState.sectionChangeTransition.set(a,!1);l.$broadcast(f.Events.Section.ChangeSection,a,!0)}function B(a){b.sectionState.setCurrent(a);b.itemState.setCurrent(a.CurrentItem);v=a.TimeTaken;h.Start();l.$emit(f.Events.Section.TimerStarted,!0);b.sectionState.currentStartTime=h.GetTestTime();a.Status=f.Status.Started;n=a;l.$emit(f.Events.Server.PRSync,f.PR_SOURCE.SECTION_STARTED);a.Instruction&&!b.testState.isTestProctorPaused&&
(h.SetStatusOn(),b.sectionState.instruction.setOn(),h.Stop(),k.Show({title:TEST_SECTION_INSTR_HEADER+" "+a.SectionName,message:a.Instruction||"No specific instruction for this section",actions:[RR_BTN_OK],modalClass:"modal-lg",type:g.Dialogue.Type.SECTION_INSTRUCTION,priority:g.Dialogue.Priority.MESSAGE,callback:function(){b.sectionState.instruction.setOff();h.Start();l.$broadcast(f.Events.Test.HideSectionInstruction,{currentQid:b.sectionState.current.CurrentItem.Question.QuestionID});k.Hide()}}))}
function t(a){a=a||b.sectionState.current;if(a.IsTimed&&a.Status==f.Status.Completed)a.TimeTaken=a.Duration;else{var d=h.GetTestTime(),c=0;a.Status!=f.Status.NotStarted&&(c=b.sectionState.currentStartTime-d);a.TimeTaken=v+(isNaN(c)?0:c)}}function w(a){var d=b.sectionState.current;if(!d.EnforceQuestionAttempt||!b.testState.isTestDisplayed||b.sectionState.timedOut.get(d.Index))return!0;var c=!1;a="f"==a?RR_COMPULSORY_TEXT_1:RR_COMPULSORY_TEXT_2;for(var e in d.Items)if(!isNaN(e)&&!d.Items[e].IsAttempted){c=
!0;break}c&&k.ShowAlert({title:a});return!c}var k=g.Dialogue,n,v=0;this.startSection=function(a){n&&s(n);a.IsTimed&&h.Initialize({section:a,onExpiry:u,startNow:b.testState.isTestDisplayed});B(a)};this.canFinishCurrentSection=w;this.canChangeToSection=function(a){var d=b.sectionState.current,c=p.defer();if(a==d.Index)return p.reject("Same section switching not allowed.");if(!w("s"))return c.reject("Section switching not allowed."),c.promise;a=m.sections.getByIndex(a);if(!a)return c.reject("No section found to switch");
a.IsComplete()?(k.ShowAlert({title:TEST_POPUP_TITLE_SECTION_ATTEMPTED,type:g.Dialogue.Type.SECTION_CHANGE}),c.reject("Section attempting not allowed")):d.IsTimed&&d.Status!=f.Status.Completed?0>=h.GetTestTime()-h.GetSectionTime()?(g.Dialogue.ShowAlert({title:"This is the last section, You can not navigate from this section.",type:g.Dialogue.Type.SECTION_CHANGE}),c.reject("No time left in the section.")):k.ShowConfirm({message:k.GetTemplate("finish-section-template",{}),title:TEST_FINISH_SECTION,actions:[BTN_CANCEL,
BTN_FIN_SEC],type:g.Dialogue.Type.SECTION_CHANGE,callback:function(a){if(a=a==BTN_FIN_SEC)b.itemState.current.Status=f.Status.Completed,d.Status=f.Status.Completed,s(d),l.$emit(f.Events.Server.PRSync,"Section Finished for "+d.Index);l.$emit(f.Events.Test.FinishSectionWindow,{category:"sectionTimeWindow",action:a?"Finish":"Cancel",data:{qIndex:d.CurrentItem.Index,qNumber:d.CurrentItem.Index+1}});c.resolve(a)}}):c.resolve(!0);return c.promise};this.updateTimeTakenForSection=t;this.getSectionSummaryCounts=
function(a){for(var b=0,c=0,e=0;e<a.Items.length;e++)a.Items[e].IsAttempted&&b++,a.Items[e].IsFlagged&&c++;return{attemptedCount:b,unAttemptedCount:a.Items.length-b,markedForReviewCount:c}};this.timeOutSection=u}])});