define2("directives/testWindowDirectives services/testWindowFactory services/testWindowTestStateService services/testWindowServerUtilsService services/testWindowCommonUtils services/testWindowConstants services/instructionService services/testWindowHelperService services/sebConnectionService ../constants/proctoringConstants".split(" "),function(){angular.module("mettl").register.controller("StartTestCtrl",["$scope","$log","$state","$interval","TestWindowFactory","TestWindowTestStateService","TestWindowServerUtilsService",
"TestWindowCommonUtils","TestWindowConstants","InstructionService","TestWindowHelperService","$injector","SEBConnectionService","ProctoringConstants",function(a,n,k,f,g,e,t,u,p,v,q,w,x,y){function r(c){d&&f.cancel(d);a.enableLoading=!1;var b=p.STErrorType;switch(c){case b.duplicate:a.errorTitle=TEST_ERR_DUPLICATE_TEST_2;a.errorMessage=TEST_ERR_DUPLICATE_TEST_1;a.isBlocked=!0;break;case b.finished:a.errorMessage=RGTN_ERR_TEST_COMPLETED;a.isBlocked=!0;break;case b.expired:a.errorMessage=TEST_ERR_EXPIRED_TEST;
a.isBlocked=!0;break;case b.inadequate:a.errorMessage='\x3cspan class\x3d"red"\x3e'+TEST_ERR_OVER_QUOTA_1+"\x3c/span\x3e"+TEST_ERR_OVER_QUOTA_2;a.isBlocked=!0;break;case b.timeout:a.errorTitle="Something went wrong";a.errorMessage="Please try again. If problem persist, close the test-window and re-start the test";a.allowRetry=!0;break;case b.RGTN_ERR_INSUFFICIENT_BAL:a.errorMessage=RGTN_ERR_INSUFFICIENT_BAL;a.isBlocked=!0;break;default:a.errorTitle="Something went wrong",a.errorMessage="Please re-start your test",
a.isBlocked=!0}}function s(){a.enableLoading=!0;t.startTest().then(function(){a.opts.browserLock?x.establishWebSocketConnectionWithSEBAndSendMessage({message:p.SEB.StartTimer}).then(function(){k.go("testWindow")},r):k.go("testWindow")},r)}if(a.$parent.initialised){var h=q.Dialogue,l;a.isTaskBasedAndResumeAllowed=g.get().TaskBasedAndResumeAllowed;a.isTaskBasedAssessment=a.opts.isTaskBasedTest;v.getTestInstruction().then(function(c){a.testInstruction=c;a.testInstruction.sections=angular.fromJson(c.SectionsJSON);
c=g.get();for(var b=0;b<c.QuestionTypes.length;b++)if(("MSQ"==c.QuestionTypes[b]||"LONG_ANSWER"==c.QuestionTypes[b])&&/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){a.isMsqOrLongQuestionOnDevice=!0;break}});a.isFirstAttempt=1==e.testState.testAttemptNumber;a.fixedSectionOrder=e.testState.fixedSectionOrder||!1;a.isFirstAttempt&&(a.sections=g.sections.getSectionsInfo(),a.currentSectionIndex=0);a.remainingTime=60;a.isAuthorizedProctored=a.opts.proctoringSettings.authorization;
a.isPractiseTest=e.testState.isPractiseTest;a.isBlocked=!1;a.allowRetry=!1;var m,d;a.isAuthorizedProctored&&(d=f(function(){a.remainingTime--;0==a.remainingTime&&(d&&f.cancel(d),a.goToTest())},1E3,!1));u.syncParent("testLoaded",{});a.$on(y.AppletMessageType.SELF_OFFLINE,function(a,b){n.debug("Disconnected from servers");m||(m=w.get("ProctoringProviderFactory"));m.getCommunicationProvider().reconnect()});a.changeSection=function(c){a.currentSectionIndex=parseInt(c);g.sections.selectedSectionIndex=
parseInt(a.currentSectionIndex)};a.isOneSectionUntimed=function(){return q.checkAnyUntimedSection(a.testInstruction.sections)};a.goToTest=function(){a.opts.visualProctoring&&!e.testState.CandidateProctoringConsentGiven?l||(l=!0,h.ShowAlert({title:MONITORED_SESSION_TEXT,message:h.GetTemplate("proctoring-monitored-session-template"),type:h.Type.MONITORED_SESSION,priority:h.Priority.MONITORED_SESSION,actions:[BTN_CANCEL,PROCEED_TO_TEST_TEXT],callback:function(a){a==PROCEED_TO_TEST_TEXT&&(e.testState.CandidateProctoringConsentGiven=
!0,s());l=!1}}),$(document).ready(function(){$("body").find("._i18").each(function(){var a=$(this),b=a.attr("data-i18");a.html(window.LanguageMap[b])})})):s()};a.$on("$destroy",function(){d&&f.cancel(d)})}else n.log("redirecting to diagnostics"),k.go("diagnostics")}])});