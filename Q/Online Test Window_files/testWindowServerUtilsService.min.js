define2("services/testWindowFactory services/testWindowTimerService services/testWindowHelperService services/testWindowConstants services/testWindowTestStateService services/testWindowQuestionService services/testWindowSectionService services/errorLogService services/navigationControlService ../constants/proctoringConstants".split(" "),function(){angular.module("mettl").register.service("TestWindowServerUtilsService",["$rootScope","$injector","ProctoringConstants","TestWindowFactory","TestWindowTimerService",
"TestWindowHelperService","TestWindowConstants","TestWindowTestStateService","TestWindowQuestionService","TestWindowSectionService","$log","$q","TestWindowCommonUtils","$timeout","ErrorLogService","NavigationControlService",function(h,K,B,l,y,u,d,e,L,M,f,C,p,v,D,N){function E(c){function d(b){var a=$("#client-network-Timer");a.tickTock("destroy");a.tickTock({time:b,startNow:!0,onExpiry:function(){a.tickTock("destroy");E(c)}})}w+=1;var a;F(function(){a&&(clearTimeout(a),a=null);var b=g.GetTemplate("client-connected-to-internet-template");
$(".modal").find(".rr-popup-network-right").html(b);G(c)},function(){this.onload=this.onabort=this.onerror=function(){};a&&(clearTimeout(a),a=null);var b=g.GetTemplate("client-connect-second-attempt-template"),b=$(".rr-popup-network-right").find("._client").empty().html(b);1==w?d(30):2==w?(b.find("._attempt").html(TEST_POPUP_NETWORK_RESTORED_MSG_3_4),d(60)):(b=g.GetTemplate("failed-client-network-template"),$(".modal").find(".rr-popup-network-right").empty().html(b))})}function F(c,e){var a=new Image;
a.onerror=a.onabort=e;a.onload=function(){c()};a.src=d.Url._1pxImgUrl+"?"+(new Date).getTime();imgLoadTimer=setTimeout(function(b){return function(){e.call(b)}}(a),6E3)}function H(c,d,a){function b(){e();O();v.cancel(n)}f.log("Inside ping applet function");D.log("disconnection with applet.ciid:"+m,!0,!0);z||(z=K.get("ProctoringProviderFactory"));z.getCommunicationProvider().reconnect();var e=h.$on(I.CONNECTION_SUCCESS,function(a,c){f.log("Got Online user message");q.isApplet=!1;b();d()}),O=h.$on(B.ServerMessageType.SELF_OFFLINE,
function(c,n){f.log("Got connection failed message");b();a()}),n=v(function(){f.log("Timeout event occurred while waiting reply from applet");f.log("Value of networkProblemReason.isApplet is ",q.isApplet);b();a()},2E4)}function J(c,d,a){c=(p.sendDataOnAUI()||"FTfail"==c.call?"/ping?ciid\x3d"+m:conf.getPrServerUrl()+"/health")+("?t\x3d"+(new Date).getTime())+("\x26ciid\x3d"+m);D.log("disconnection with pr .ciid:"+m,!0,!0);$.ajax({url:c,type:"GET",timeout:2E4,success:function(b){f.log("Ping success");
q.isPR=!1;d()},error:function(b){f.log("Ping error",b);a()}})}function G(c){function k(){q.isPR?J(c,k,x):q.isApplet?H(c,k,x):a()}function a(){f.log("Inside handle success");var b=g.GetTemplate("connection-restored-template"),b=$(".modal").find(".rr-popup-network-right").html(b);"FTfail"==c.call&&b.find(".action").html("Submitting");e.retry.setRetry(!1);$("#resume-timer").tickTock({time:5,startNow:!0,onExpiry:function(){"FTfail"==c.call?c.callback():(g.Hide(),h.$broadcast(d.Events.Test.UnPauseTest,
void 0),v(function(){r.syncWithServer(d.PR_SOURCE.CONNECTION_RESTORED)},500),h.$broadcast(d.PR_SOURCE.CONNECTION_RESTORED,{currentQid:e.sectionState.current.CurrentItem.Question.QuestionID}))}})}function b(b){var a=$("#server-network-Timer");a.tickTock("destroy");a.tickTock({time:b,startNow:!0,onExpiry:function(){a.tickTock("destroy");G(c)}})}function x(){f.log("Inside handle Error");t+=1;var a=$(".modal").find(".rr-popup-network-right").find("._server");if(1==t){var d=g.GetTemplate("server-connect-second-attempt-template");
a.html(d);b(30)}else 2==t?(a.find(".attemptCount").html(TEST_POPUP_NETWORK_RESTORED_MSG_3_4),b(60)):("FTfail"!=c.call&&(c.title="Server Not Responding"),P(c,"server-connect-failure-template"))}f.log("Inside _ping function "+JSON.stringify(c));f.log("serverNetworkCheckCount is now __ "+t);switch(c.source){case d.Events.NetWorkErrorReason.applet:H(c,k,x);break;default:J(c,k,x)}}function P(c,d){f.log("ServerErrorManualHandling opts \x3e "+JSON.stringify(c));g.Hide();g.Refresh();g.ShowAlert({title:c.title,
type:c.type,message:g.GetTemplate(d),actions:[RR_BTN_CLOSE],callback:function(a){e.testState.isTestEnding=!0;p.closeWindow()}})}function Q(c){var k=$("#resume-timer");0<k.length&&(k.tickTock("destroy"),g.Hide());e.retry.setRetry(!0);N.isNavigationAllowed(d.NavigationAway.INTERNET_DISCONNECTION).then(function(){h.$broadcast(d.Events.Test.PauseTest,void 0);var a={};a.type=g.Type.NETWORK_PROBLEM;a.priority=g.Priority.ERROR;a.problem="network";a.title=DIAG_INTR_CONN_ISSUE;a.message=g.GetTemplate("internet-connection-issue-template");
a.source=c;a.modalClass="modal-lg";a.callback=function(b,c){b==TEST_POPUP_NO_INTERNET_MSG_4&&(g.Hide(),e.retry.setRetry(!1),A(a.source))};g.Show(a)})["catch"](function(a){f.error("Navigation not allowed in case of Internet Disconnection. Error: ",a)})}function A(c){setTimeout(function(){Q(c)},100)}var g=u.Dialogue,I=B.AppletMessageType,m,w=0,t=0,z,q={isApplet:!1,isPR:!1,isWebRTC:!1};h.$on(d.Events.Server.PRSync,function(c,d){r.syncWithServer(d)});h.$on(I.SELF_OFFLINE,function(c,g){m&&(f.info("New showNetworkProblemDueToApplet request"),
q.isApplet=!0,e.retry.isRetrying()?f.info("New showNetworkProblemDueToApplet request ignored"):A(d.Events.NetWorkErrorReason.applet))});h.$on(d.Events.Server.CheckNetwork,function(d,e){t=w=0;E(e)});var r=new function(){function c(){var b="?ciid\x3d"+m,b={url:p.sendDataOnAUI()?"/ping"+b:conf.getPrServerUrl()+"/ping"+b,timeout:1E4,success:function(b){r.serverSync.pingRefresh();e.retry.OnPingPr.Refresh();e.retry.setRetry(!1)},error:function(b,c,n){f.log("there was a problem sending the ping response");
e.retry.OnPingPr.Count+=1;2<e.retry.OnPingPr.Count&&a(d.PR_SOURCE.NORMAL)}};p.sendDataOnAUI()?(b.method="GET",b.cache=!1):(b.dataType="jsonp",b.jsonpCallback="pingCallback");$.ajax(b)}function k(b){f.log("partial successfully sent!!!!");h.$broadcast(d.Events.Server.PRSyncSuccess);r.serverSync.Refresh();e.retry.OnPartialResponse.Refresh();e.retry.OnPingPr.Refresh();e.retry.setRetry(!1);b==d.PR_SOURCE.SAVE_AND_CLOSE&&p.closeWindow()}function a(b){if(r.serverSync.CanSync()){M.updateTimeTakenForSection();
L.saveLastItem();var a;try{a=l.getOptimizedJsonData(b,y.GetTestTime())}catch(c){f.log("Error in preparing candidate data, Reason \x3e "+c.message);g.ShowServerErrorMessage(function(){p.closeWindow()},!1,!0);return}u.AJAXC({url:"/store",data:a,timeout:75E3,success:function(a){"invalid"==a.candidateStatus&&f.log("timer discrepancy found...");"duplicate"==a.candidateStatus?(e.testState.isTestEnding=!0,y.Stop(),g.ShowErrorMessage(TEST_NETWORK_RESTORE_DUPLICATE_TEST,function(){p.closeWindow()},"Error",
!1)):b==d.PR_SOURCE.CONNECTION_RESTORED?r.checkForTestExpiry(b):k(b)},error:function(b,a,c){f.log("there was a problem sending the partial response "+a);e.retry.OnPartialResponse.Count+=1;if(2<e.retry.OnPingPr.Count||4<e.retry.OnPartialResponse.Count)f.info("New showNetworkProblemDueToPR request"),q.isPR=!0,e.retry.isRetrying()?f.info("New showNetworkProblemDueToPR request ignored"):A(d.Events.NetWorkErrorReason.pr)}})}}return{syncWithServer:a,pingPrServer:function(){c()},checkForTestExpiry:function(b){u.AJAX({url:"/checkForTestExpiry",
cache:!1,data:{c:m},timeout:6E4,success:function(a){"error_expiredST"==a.status?(y.Stop(),e.testState.isTestEnding=!0,g.ShowErrorMessage("Sorry! Cannot resume test because this test has expired.",function(){h.$broadcast(d.Events.Test.TestExpired)},"Test has expired")):k(b)}})},serverSync:new function(){function b(){cn.neyzoter.test.isTaskBasedAssessment()&&(k=3E5);s&&clearInterval(s);s=setInterval(function(){a(d.PR_SOURCE.NORMAL)},k)}function f(){1==n&&(h=setInterval(function(){c()},15E3),n=!1)}var g=!1,n=
!0,s,h,k=85E3;return{Index:1,CanSync:function(){return g&&!(!e.testState.isTestStarted||e.testState.isPreview)&&!e.testState.isTestEnding},Disable:function(){s&&clearInterval(s);h&&clearInterval(h);g=!1},Enable:function(){g=!0;b();n=!0;f()},Refresh:function(){clearInterval(s);b()},pingRefresh:function(){clearInterval(h);n=!0;f()}}},startTest:function(){var b=C.defer(),a=l.getSTData(),c=encodeURIComponent(cn.neyzoter.test.getCandidateKey());v(function(){u.AJAX({url:"/st?c\x3d"+c,cache:!1,data:a,timeout:3E5,
success:function(a){a.status==d.STErrorType.duplicate?b.reject(d.STErrorType.duplicate):a.status==d.STErrorType.RGTN_ERR_INSUFFICIENT_BAL?b.reject(d.STErrorType.RGTN_ERR_INSUFFICIENT_BAL):(a=l.PopulateTestTwContent(a,b),l.handlePostLoadContent(a,b),m=cn.neyzoter.test.getCandidateInstanceId(),b.resolve())},error:function(a, c, e){c&&"timeout"==c.toLowerCase()?a=d.STErrorType.timeout:a&&a.responseText?(a=a.responseText,a=-1!=a.indexOf("finished")?d.STErrorType.finished:-1!=a.indexOf("expired")?d.STErrorType.expired:
-1!=a.indexOf("inadequate")?d.STErrorType.inadequate:d.STErrorType.unhandled):a=d.STErrorType.unhandled;b.reject(a)}})},500);return b.promise},startPreviewTest:function(){var a=C.defer(),c={previewDataKey:document.getElementById("previewDataKey").value};v(function(){u.AJAX({url:"/preview-st",cache:!1,data:c,timeout:3E5,success:function(c){c=l.PopulateTestTwContent(c,a);l.handlePostLoadContent(c,a);m=cn.neyzoter.test.getCandidateInstanceId();a.resolve()},error:function(c, d, e){a.reject(e)}})},500);return a.promise},
load1pxImage:F}};return r}])});