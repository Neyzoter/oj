(function(k,e){function b(e,c){this.$get=["webRtcProviderService",function(c){return c}]}var r=e.module("webRTC",[]);r.provider("$webRTC",b);b.$inject=["$provide","$compileProvider"];r.service("webRtcProviderService",["$window","$rootScope","$q","WebRTCStreamService","CameraUtilService","WebRTCProviderFactory",function(e,c,r,b,k,B){this.getWebRTCPreferences=function(){return b.getWebRTCPreferences()};this.getStreamDataUrl=function(){return b.getStreamDataUrl()};this.showStream=function(c){return b.showStream(c)};
this.startWebRTC=function(c){return b.startWebRTC(c)};this.startVideoStreamByIndex=function(c,e,u){return b.startVideoStreamByIndex(c,e,u)};this.stopWebRTC=function(c){return b.stopWebRTC(c)};this.captureImage=function(){return k.captureImage()};this.checkForWorkingCamera=function(){return k.checkForWorkingCamera()};this.stopCheckForWorkingCamera=function(){return k.stop()};this.init=function(c,e,b){return B.init(c,e,b)};this.isMediaStreamActive=function(){return b.isMediaStreamActive()};this.getWebcamInfo=
function(){return b.getWebcamInfo()};this.getSelectedVideoDevice=function(){return b.getSelectedVideoDevice()}}])})(window,window.angular);var webRTCProvider=function(){return{loadFiles:function(k){"function"==typeof k&&k()}}}(),webRTC=angular.module("webRTC");
webRTC.constant("WebRTCErrorConstants",{BrowserUserMediaType:{OVER_CONSTRAINED_ERROR:"OverconstrainedError",INVALID_CONSTRAINT:"invalid constraint"},CameraUtil:{VIDEO_STREAM_NOT_AVAILABLE:"videoStreamNotAvailable",CAMERA_UNAVAILABLE:"CAMERA_UNAVAILABLE"},WebRTC:{MEDIA_DEVICE_ERROR:"mediaDeviceError",PERMISSION_NOT_GRANTED:"webrtcPermissionNotGranted",PERMISSION_NOT_GRANTED_TO_A_DEVICE:"webrtcPermissionNotGrantedToADevice",MULTIPLE_WEBCAM:"multipleWebCam",WEBCAM_NOT_FOUND:"webCamError",AUDIO_PERMISSION_NOT_GRANTED:"audioPermissionNotGranted",
MICROPHONE_NOT_FOUND:"microphoneError"}});var webRtcStream=angular.module("webRTC");
webRtcStream.factory("UserMediaFactory",["$log",function(k){var e=0,b={"320*240":{w:{min:160,max:320},h:{min:120,max:240}},"640*480":{w:{min:320,max:640},h:{min:240,max:480}},"1024*720":{w:{min:640,max:1024},h:{min:480,max:720}},"1280*960":{w:{min:1024,max:1280},h:{min:720,max:960}},"1920*1440":{w:{min:1280,max:1920},h:{min:960,max:1440}}},r=Object.keys(b).length-1;return{getUserResolutionNumber:function(){return e},setUserResolutionNumber:function(b){e=b},getMaxResolutionNumber:function(){return r},
getResolutions:function(){if(e>r||0>e)e=0;var u=Object.keys(b)[e];return b[u]}}}]);webRTC=angular.module("webRTC");
webRTC.factory("UtilityFactory",["$log","$q","UserMediaFactory",function(k,e,b){return{makeMessage:function(e,b){return{type:e,data:b}},getCanvasById:function(e){var b=document.getElementById(e);if("undefined"==typeof b||null==b)b=document.createElement("canvas"),b.setAttribute("id",e),b.setAttribute("style","display:none"),document.body.appendChild(b);return b},createVideoElement:function(e){k.info("Creating video element!");var b=document.createElement("video");b.setAttribute("id",e);b.setAttribute("style",
"height:1px;width:1px;position:fixed;top:200px;");b.setAttribute("playsinline","");b.autoplay=!DetectRTC.browser.isSafari;b.muted=!0;return b},compressImage:function(e,u){var c=10,p=1,A=!1;"camera"==u&&(c=b.getUserResolutionNumber()+1);for(var c=10*c,x,B=!0;.01<p&&!A;)x=e.toDataURL("image/jpeg",p),B&&(k.info("Original image size in byte is ",x.length),B=!1),x.length/1024<c?A=!0:p-=.1>=p?.01:.05;k.info("Final image size in byte is ",x.length);k.info("Final image compression is ",p);return x}}}]);
var webRtc=angular.module("webRTC");webRtc.factory("WebRTCProviderFactory",["$log",function(k){var e,b,r;return{init:function(k,c,p){r=p;b=void 0!=c?c:!0;e=k||{}},isAudioMandatory:function(){return b},getLogData:function(){return e},getCallBackUrlForMessage:function(){return r}}}]);
(function(){function k(a,f){var g=0,d=!1,c=window.setInterval(function(){a()&&(window.clearInterval(c),f(d));50<g++&&(window.clearInterval(c),d=!0,f(d))},10)}function e(a){a=a.toLowerCase();return 0===a.indexOf("msie")&&0===a.indexOf("trident")?!1:(a=/(?:msie|rv:)\s?([\d\.]+)/.exec(a))&&10<=parseInt(a[1],10)?!0:!1}function b(){var a=c.appVersion,f=c.userAgent,g="-",d=[{s:"Windows 10",r:/(Windows 10.0|Windows NT 10.0)/},{s:"Windows 8.1",r:/(Windows 8.1|Windows NT 6.3)/},{s:"Windows 8",r:/(Windows 8|Windows NT 6.2)/},
{s:"Windows 7",r:/(Windows 7|Windows NT 6.1)/},{s:"Windows Vista",r:/Windows NT 6.0/},{s:"Windows Server 2003",r:/Windows NT 5.2/},{s:"Windows XP",r:/(Windows NT 5.1|Windows XP)/},{s:"Windows 2000",r:/(Windows NT 5.0|Windows 2000)/},{s:"Windows ME",r:/(Win 9x 4.90|Windows ME)/},{s:"Windows 98",r:/(Windows 98|Win98)/},{s:"Windows 95",r:/(Windows 95|Win95|Windows_95)/},{s:"Windows NT 4.0",r:/(Windows NT 4.0|WinNT4.0|WinNT|Windows NT)/},{s:"Windows CE",r:/Windows CE/},{s:"Windows 3.11",r:/Win16/},{s:"Android",
r:/Android/},{s:"Open BSD",r:/OpenBSD/},{s:"Sun OS",r:/SunOS/},{s:"Linux",r:/(Linux|X11)/},{s:"iOS",r:/(iPhone|iPad|iPod)/},{s:"Mac OS X",r:/Mac OS X/},{s:"Mac OS",r:/(MacPPC|MacIntel|Mac_PowerPC|Macintosh)/},{s:"QNX",r:/QNX/},{s:"UNIX",r:/UNIX/},{s:"BeOS",r:/BeOS/},{s:"OS/2",r:/OS\/2/},{s:"Search Bot",r:/(nuhk|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask Jeeves\/Teoma|ia_archiver)/}],b;for(b in d){var e=d[b];if(e.r.test(f)){g=e.s;break}}d="-";/Windows/.test(g)&&(/Windows (.*)/.test(g)&&(d=/Windows (.*)/.exec(g)[1]),
g="Windows");switch(g){case "Mac OS X":/Mac OS X (10[\.\_\d]+)/.test(f)&&(d=/Mac OS X (10[\.\_\d]+)/.exec(f)[1]);break;case "Android":/Android ([\.\_\d]+)/.test(f)&&(d=/Android ([\.\_\d]+)/.exec(f)[1]);break;case "iOS":/OS (\d+)_(\d+)_?(\d+)?/.test(f)&&(d=/OS (\d+)_(\d+)_?(\d+)?/.exec(a),d=d[1]+"."+d[2]+"."+(d[3]|0))}return{osName:g,osVersion:d}}function r(c){function f(f){var d=/([0-9]{1,3}(\.[0-9]{1,3}){3})/.exec(f);d?(f=d[1],void 0===g[f]&&c(f),g[f]=!0):console.warn("Could not match IP address in",
f)}var g={},d=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,b=!!window.webkitRTCPeerConnection;if(!d){d=document.getElementById("iframe");if(!d)throw"NOTE: you need to have an iframe in the page right above the script tag.";b=d.contentWindow;d=b.RTCPeerConnection||b.mozRTCPeerConnection||b.webkitRTCPeerConnection;b=!!b.webkitRTCPeerConnection}if(d){var e;b&&(e={iceServers:[{urls:"stun:stun.services.mozilla.com"}]},"undefined"!==typeof a&&a.browser.isFirefox&&
38>=a.browser.version&&(e[0]={url:e[0].urls}));var q=new d(e,{optional:[{RtpDataChannels:!0}]});q.onicecandidate=function(d){d.candidate&&f(d.candidate.candidate)};q.createDataChannel("");q.createOffer(function(f){q.setLocalDescription(f,function(){},function(){})},function(){});setTimeout(function(){q.localDescription.sdp.split("\n").forEach(function(d){0===d.indexOf("a\x3dcandidate:")&&f(d)})},1E3)}}function u(b){m?(!c.enumerateDevices&&window.MediaStreamTrack&&window.MediaStreamTrack.getSources&&
(c.enumerateDevices=window.MediaStreamTrack.getSources.bind(window.MediaStreamTrack)),!c.enumerateDevices&&c.enumerateDevices&&(c.enumerateDevices=c.enumerateDevices.bind(c)),c.enumerateDevices?(y=[],C=[],G=[],q=[],c.enumerateDevices(function(f){f.forEach(function(f){var d={},a;for(a in f)d[a]=f[a];"audio"===d.kind&&(d.kind="audioinput");"video"===d.kind&&(d.kind="videoinput");var c;y.forEach(function(f){f.id===d.id&&f.kind===d.kind&&(c=!0)});c||(d.deviceId||(d.deviceId=d.id),d.id||(d.id=d.deviceId),
d.label?("videoinput"!==d.kind||v||(v=!0),"audioinput"!==d.kind||K||(K=!0)):(d.label="Please invoke getUserMedia once.","https:"!==location.protocol&&document.domain.search&&-1===document.domain.search(/localhost|127.0./g)&&(d.label="HTTPs is required to get label of this "+d.kind+" device.")),"audioinput"===d.kind&&(N=!0,-1===C.indexOf(d)&&C.push(d)),"audiooutput"===d.kind&&(D=!0,-1===G.indexOf(d)&&G.push(d)),"videoinput"===d.kind&&(n=!0,-1===q.indexOf(d)&&q.push(d)),-1===y.indexOf(d)&&y.push(d))});
"undefined"!==typeof a&&(a.MediaDevices=y,a.hasMicrophone=N,a.hasSpeakers=D,a.hasWebcam=n,a.isWebsiteHasWebcamPermissions=v,a.isWebsiteHasMicrophonePermissions=K,a.audioInputDevices=C,a.audioOutputDevices=G,a.videoInputDevices=q);b&&b()})):b&&b()):b&&b()}(function(a){"undefined"===typeof window&&("undefined"===typeof window&&"undefined"!==typeof global&&(global.navigator={userAgent:"Fake/5.0 (FakeOS) AppleWebKit/123 (KHTML, like Gecko) Fake/12.3.4567.89 Fake/123.45",getUserMedia:function(){}},a.window=
global),"undefined"===typeof document&&(a.document={},document.createElement=document.captureStream=document.mozCaptureStream=function(){return{}}),"undefined"===typeof location&&(a.location={protocol:"file:",href:"",hash:""}),"undefined"===typeof screen&&(a.screen={width:0,height:0}))})("undefined"!==typeof global?global:window);var c=window.navigator;"undefined"!==typeof c?("undefined"!==typeof c.webkitGetUserMedia&&(c.getUserMedia=c.webkitGetUserMedia),"undefined"!==typeof c.mozGetUserMedia&&(c.getUserMedia=
c.mozGetUserMedia)):c={getUserMedia:function(){},userAgent:"Fake/5.0 (FakeOS) AppleWebKit/123 (KHTML, like Gecko) Fake/12.3.4567.89 Fake/123.45"};var p=!!/Android|webOS|iPhone|iPad|iPod|BB10|BlackBerry|IEMobile|Opera Mini|Mobile|mobile/i.test(c.userAgent||""),A=-1!==c.userAgent.indexOf("Edge")&&(!!c.msSaveOrOpenBlob||!!c.msSaveBlob),x=!!window.opera||0<=c.userAgent.indexOf(" OPR/"),B="undefined"!==typeof window.InstallTrigger,L=0<Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor"),
J=!!window.chrome&&!x,M=!!document.documentMode&&!A,t={Android:function(){return c.userAgent.match(/Android/i)},BlackBerry:function(){return c.userAgent.match(/BlackBerry|BB10/i)},iOS:function(){return c.userAgent.match(/iPhone|iPad|iPod/i)},Opera:function(){return c.userAgent.match(/Opera Mini/i)},Windows:function(){return c.userAgent.match(/IEMobile/i)},any:function(){return t.Android()||t.BlackBerry()||t.iOS()||t.Opera()||t.Windows()},getOsName:function(){var a="Unknown OS";t.Android()&&(a="Android");
t.BlackBerry()&&(a="BlackBerry");t.iOS()&&(a="iOS");t.Opera()&&(a="Opera Mini");t.Windows()&&(a="Windows");return a}},h="Unknown OS",z="Unknown OS Version";t.any()?h=t.getOsName():(z=b(),h=z.osName,z=z.osVersion);var H=!1,E=!1;["captureStream","mozCaptureStream","webkitCaptureStream"].forEach(function(a){!H&&a in document.createElement("canvas")&&(H=!0);!E&&a in document.createElement("video")&&(E=!0)});var y=[],C=[],G=[],q=[];c.mediaDevices&&c.mediaDevices.enumerateDevices&&(c.enumerateDevices=function(a){c.mediaDevices.enumerateDevices().then(a)["catch"](function(){a([])})});
var m=!1;"undefined"!==typeof MediaStreamTrack&&"getSources"in MediaStreamTrack?m=!0:c.mediaDevices&&c.mediaDevices.enumerateDevices&&(m=!0);var N=!1,D=!1,n=!1,K=!1,v=!1;u();var a=window.DetectRTC||{};a.browser=function(){var a=c.userAgent,f=c.appName,g=""+parseFloat(c.appVersion),d=parseInt(c.appVersion,10),b,e;if(x){f="Opera";try{g=c.userAgent.split("OPR/")[1].split(" ")[0],g.split(".")}catch(q){g="0.0.0.0"}}else M?(b=a.indexOf("MSIE"),f="IE",g=a.substring(b+5)):J?(b=a.indexOf("Chrome"),f="Chrome",
g=a.substring(b+7)):L?(b=a.indexOf("Safari"),f="Safari",g=a.substring(b+7),-1!==(b=a.indexOf("Version"))&&(g=a.substring(b+8))):B?(b=a.indexOf("Firefox"),f="Firefox",g=a.substring(b+8)):(d=a.lastIndexOf(" ")+1)<(b=a.lastIndexOf("/"))&&(f=a.substring(d,b),g=a.substring(b+1),f.toLowerCase()===f.toUpperCase()&&(f=c.appName));A&&(f="Edge",g=parseInt(c.userAgent.match(/Edge\/(\d+).(\d+)$/)[2],10).toString());-1!==(e=g.indexOf(";"))&&(g=g.substring(0,e));-1!==(e=g.indexOf(" "))&&(g=g.substring(0,e));d=
parseInt(""+g,10);isNaN(d)&&(g=""+parseFloat(c.appVersion),d=parseInt(c.appVersion,10));return{fullVersion:g,version:d,name:f,isPrivateBrowsing:!1}}();(function(a){var f;if(window.webkitRequestFileSystem)window.webkitRequestFileSystem(window.TEMPORARY,1,function(){f=!1},function(a){f=!0});else if(window.indexedDB&&/Firefox/.test(window.navigator.userAgent)){var g;try{g=window.indexedDB.open("cn.neyzoter.test"),g.onerror=function(){return!0}}catch(d){f=!0}"undefined"===typeof f&&k(function(){return"done"===g.readyState},
function(a){a||(f=g.result?!1:!0)})}else if(e(window.navigator.userAgent)){f=!1;try{window.indexedDB||(f=!0)}catch(d){f=!0}}else if(window.localStorage&&/Safari/.test(window.navigator.userAgent)){try{window.localStorage.setItem("cn.neyzoter.test",1)}catch(d){f=!0}"undefined"===typeof f&&(f=!1,window.localStorage.removeItem("cn.neyzoter.test"))}k(function(){return"undefined"!==typeof f},function(d){a(f)})})(function(b){a.browser.isPrivateBrowsing=!!b});a.browser["is"+a.browser.name]=!0;var w=!1;["RTCPeerConnection","webkitRTCPeerConnection",
"mozRTCPeerConnection","RTCIceGatherer"].forEach(function(a){w||a in window&&(w=!0)});a.isWebRTCSupported=w;a.isORTCSupported="undefined"!==typeof RTCIceGatherer;var l=!1;a.browser.isChrome&&35<=a.browser.version?l=!0:a.browser.isFirefox&&34<=a.browser.version&&(l=!0);"https:"!==location.protocol&&(l=!1);a.isScreenCapturingSupported=l;var I=!1,F=!1;["AudioContext","webkitAudioContext","mozAudioContext","msAudioContext"].forEach(function(a){!I&&a in window&&(I=!0,"createMediaStreamSource"in window[a].prototype&&
(F=!0))});a.isAudioContextSupported=I;a.isCreateMediaStreamSourceSupported=F;l=!1;a.browser.isChrome&&31<a.browser.version&&(l=!0);a.isRtpDataChannelsSupported=l;l=!1;a.browser.isFirefox&&28<a.browser.version?l=!0:a.browser.isChrome&&25<a.browser.version?l=!0:a.browser.isOpera&&11<=a.browser.version&&(l=!0);a.isSctpDataChannelsSupported=l;a.isMobileDevice=p;p=!1;c.getUserMedia?p=!0:c.mediaDevices&&c.mediaDevices.getUserMedia&&(p=!0);a.browser.isChrome&&46<=a.browser.version&&"https:"!==location.protocol&&
(a.isGetUserMediaSupported="Requires HTTPs");a.isGetUserMediaSupported=p;a.osName=h;a.osVersion=z;h="";screen.width&&(h+=""+(screen.width?screen.width:"")+" x "+(screen.height?screen.height:""));a.displayResolution=h;a.isCanvasSupportsStreamCapturing=H;a.isVideoSupportsStreamCapturing=E;a.DetectLocalIPAddress=function(b){a.isWebRTCSupported&&(a.isORTCSupported||r(function(a){a.match(/^(192\.168\.|169\.254\.|10\.|172\.(1[6-9]|2\d|3[01]))/)?b("Local: "+a):b("Public: "+a)}))};a.isWebSocketsSupported=
"WebSocket"in window&&2===window.WebSocket.CLOSING;a.isWebSocketsBlocked=!a.isWebSocketsSupported;a.checkWebSocketsSupport=function(b){b=b||function(){};try{var f=new WebSocket("wss://echo.websocket.org:443/");f.onopen=function(){a.isWebSocketsBlocked=!1;b();f.close();f=null};f.onerror=function(){a.isWebSocketsBlocked=!0;b()}}catch(g){a.isWebSocketsBlocked=!0,b()}};a.load=function(a){u(a||function(){})};a.MediaDevices=y;a.hasMicrophone=N;a.hasSpeakers=D;a.hasWebcam=n;a.isWebsiteHasWebcamPermissions=
v;a.isWebsiteHasMicrophonePermissions=K;a.audioInputDevices=C;a.audioOutputDevices=G;a.videoInputDevices=q;h=!1;"setSinkId"in document.createElement("video")&&(h=!0);a.isSetSinkIdSupported=h;h=!1;a.browser.isFirefox&&"undefined"!==typeof mozRTCPeerConnection?"getSenders"in mozRTCPeerConnection.prototype&&(h=!0):a.browser.isChrome&&"undefined"!==typeof webkitRTCPeerConnection&&"getSenders"in webkitRTCPeerConnection.prototype&&(h=!0);a.isRTPSenderReplaceTracksSupported=h;h=!1;a.browser.isFirefox&&38<
a.browser.version&&(h=!0);a.isRemoteStreamProcessingSupported=h;h=!1;"undefined"!==typeof MediaStreamTrack&&"applyConstraints"in MediaStreamTrack.prototype&&(h=!0);a.isApplyConstraintsSupported=h;h=!1;a.browser.isFirefox&&43<=a.browser.version&&(h=!0);a.isMultiMonitorScreenCapturingSupported=h;a.isPromisesSupported=!!("Promise"in window);"undefined"===typeof a&&(window.DetectRTC={});h=window.MediaStream;"undefined"===typeof h&&"undefined"!==typeof webkitMediaStream&&(h=webkitMediaStream);a.MediaStream=
"undefined"!==typeof h?Object.keys(h.prototype):!1;a.MediaStreamTrack="undefined"!==typeof MediaStreamTrack?Object.keys(MediaStreamTrack.prototype):!1;h=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;a.RTCPeerConnection="undefined"!==typeof h?Object.keys(h.prototype):!1;window.DetectRTC=a;"undefined"!==typeof module&&(module.exports=a);"function"===typeof define&&define.amd&&define("DetectRTC",[],function(){return a})})();webRTC=angular.module("webRTC");
webRTC.service("WebRTCStreamService",["$q","$log","WebRTCErrorConstants","UserMediaFactory","$timeout","WebRTCProviderFactory","UtilityFactory",function(k,e,b,r,u,c,p){function A(a,g){"function"==typeof a&&a(g)}function x(){var a={audio:!0,audioNotMandatory:!0};D.preventAudioCheck&&(a.audio=!1);if(D.checkVideo){l=l||D.selectedVideoDevice;var g=D.videoConstraints||{},d=r.getResolutions(),b=d.w,d=d.h,c={};O||(c.width=g.width||{min:b.min,max:b.max},c.height=g.height||{min:d.min,max:d.max});c.framerate=
g.framerate||15;l&&(c.deviceId={exact:l.deviceId});a.video=c}return a}function B(){var a=k.defer(),b=x();e.log("media constraints are:",b);navigator.mediaDevices.getUserMedia(b).then(function(d){a.resolve(d)})["catch"](function(d){a.reject(d)});return a.promise}function L(){var a=k.defer(),g=r.getUserResolutionNumber();B().then(function(d){a.resolve(d)})["catch"](function(d){e.error("error occurred ",d);"function"==typeof OverconstrainedError&&d instanceof OverconstrainedError||d.name===b.BrowserUserMediaType.OVER_CONSTRAINED_ERROR?
g<r.getMaxResolutionNumber()?(I=I||c.getCallBackUrlForMessage(),d="Error occurred while getting navigator permission with resolution: "+JSON.stringify(r.getResolutions()),d={chatType:"LOG",logEvent:b.BrowserUserMediaType.OVER_CONSTRAINED_ERROR,message:d},I&&I(d),g++,r.setUserResolutionNumber(g),L().then(a.resolve,a.reject)):d.message?"safari"==DetectRTC.browser.name.toLowerCase()&&d.message.toLowerCase()==b.BrowserUserMediaType.INVALID_CONSTRAINT?(O=!0,L().then(a.resolve,a.reject)):a.reject(d):a.reject(d):
a.reject(d)});return a.promise}function J(f){var b=!1,d=!1;if(f){f=f.getTracks();for(var c=0;c<f.length&&(b||"audio"!==f[c].kind||(b=!0),d||"video"!==f[c].kind||f[c].readyState&&"ended"===f[c].readyState||(d=!0),!b||!d);c++);}return a={hasAudio:b,hasVideo:d}}function M(a){for(var b=a.toLowerCase(),d="dummy;vdp source;cyberlink webcam;manycam;youcam;webcammax;facing back;back facing;back camera".split(";"),c=0;c<d.length;c++){var q=d[c].toLowerCase();if(-1<b.indexOf(q))return e.log("A blocked device found",
a),!0}return!1}function t(a){K&&u.cancel(K);K=u(function(){q(function(){a.reject(F(v.PERMISSION_NOT_GRANTED))})},3E4)}function h(a,b){return!l&&1<b.length?(e.log("More than one video device found",b),a.notify(F(v.MULTIPLE_WEBCAM,w)),!0):!1}function z(a,b){l||(l=b[0]);e.info("selected device is",l.label);a.resolve(l)}function H(a){e.log("Permission not granted for microphone/Camera");q();a.reject(F(v.PERMISSION_NOT_GRANTED));C("Permission not granted for microphone/Camera")}function E(b,c){K&&u.cancel(K);
DetectRTC.load(function(){a=J(n);if(c.checkVideo){var d=DetectRTC.videoInputDevices;e.log("WebCams found :",d);w=[];for(var m=0;m<d.length;m++){var k=d[m];M(k.label)||w.push(k)}}c.checkVideo&&!a.hasVideo&&l?b.reject(F(v.MULTIPLE_WEBCAM,{showCameraError:!0})):c.checkVideo&&!a.hasVideo?(e.log("Permission not granted for webcam"),b.reject(F(v.PERMISSION_NOT_GRANTED))):c.checkAudio&&!a.hasAudio?c.checkVideo?(q(),b.notify(F(v.AUDIO_PERMISSION_NOT_GRANTED)),L().then(function(c){a=J(c);if(a.hasVideo&&a.hasAudio)try{n=
c,h(b,d)||z(b,w)}catch(g){H(b)}else H(b)})["catch"](function(a){H(b)})):b.reject(F(v.AUDIO_PERMISSION_NOT_GRANTED)):!c.checkVideo||"object"==typeof w&&0!=w.length?c.checkVideo&&!h(b,d)?z(b,w):c.checkVideo||b.resolve():(e.log("No video device found"),b.reject(F(v.WEBCAM_NOT_FOUND)))})}function y(){n.onactive=function(a){e.log("video device on active",a)};n.onaddtrack=function(a){e.log("video device on add track",a)};n.oninactive=function(a){e.log("video device on inactive",a)};n.onremovetrack=function(a){e.log("video device on remove track",
a)};var a=n.getTracks();a&&0<a.length&&(a[0].onended=function(a){e.log("video device on ended",a)})}function C(a){I=I||c.getCallBackUrlForMessage();var b=c.getLogData();I({chatType:"LOG",logEvent:"NAVIGATOR_PERMISSION_ERROR_OCCURRED",message:"Error occurred while asking navigator permission for : Schedule key is : "+b.scheduleKey+", candidate-email: "+b.email+", clientId: "+b.clientId+". Error is -  "+a})}function G(a){D=a;var b=k.defer();navigator.mediaDevices.getUserMedia?(r.setUserResolutionNumber(0),
L().then(function(d){e.info("Success in  getUserMedia"+d);n=d;E(b,a);y()})["catch"](function(d){C(d);e.log("The following error occurred: "+d);n=void 0;E(b,a)}),a.disableMediaPermissionTimeOut||t(b)):(e.log("getUserMedia not supported"),b.reject(F(v.MEDIA_DEVICE_ERROR)));return b.promise}function q(a){if(n){e.info("Releasing webcam stream:",n);try{n.getTracks().forEach(function(a){a.stop&&a.stop()})}catch(b){e.log("Error occurred while Releasing webcam",b)}l=void 0}A(a)}function m(){return a}function N(a){a&&
(a.srcObject=n)}function m(){return a}var D,n,K,v=b.WebRTC,a={hasAudio:!1,hasVideo:!1},w=[],l,I,F=p.makeMessage,O=!1;return{startWebRTC:G,getStreamDataUrl:function(){return n},showStream:N,stopWebRTC:q,getWebRTCPreferences:m,getWebcamInfo:function(){for(var a={webcamNames:[],selectedWebCamName:""},b=0;b<w.length;b++)a.webcamNames.push(w[b].label);l&&(a.selectedWebCamName=l.label);return a},startVideoStreamByIndex:function(a,b,d){var m=a.index,h=a.videoElement;q(function(){e.log("Using device:",m);
l=w[m];D.checkAudio=!1;G(D).then(function(){D.checkAudio=c.isAudioMandatory();var a=n;N(h);A(b,a)},function(a){e.log(a);A(d,a)})})},isMediaStreamActive:function(){if(n){if("active"in n){if(!n.active)return!1}else if("ended"in n&&n.ended)return!1;return!0}return!1},getSelectedVideoDevice:function(){return l}}}]);webRTC=angular.module("webRTC");
webRTC.service("CameraUtilService",["$log","$q","$timeout","$interval","WebRTCStreamService","WebRTCErrorConstants","UtilityFactory","WebRTCProviderFactory",function(k,e,b,r,u,c,p,A){function x(b){H=E;E=y;y=b;return H!==E||E!==y}function B(){var c=e.defer(),m=document.getElementById("mettlProctoringCam");if("undefined"==typeof m||null==m)if(G=u.getStreamDataUrl()){m=p.createVideoElement("mettlProctoringCam");m.onended=L;m.srcObject=G;document.body.appendChild(m);k.log("video element created");t(m);
var h=b(function(){c&&(k.log("video element data loaded timeout occurred"),c.resolve(m),c=void 0)},1E4);m.addEventListener("loadeddata",function(){c&&(k.log("video element data loaded"),c.resolve(m),c=void 0,b.cancel(h))},!1)}else c.reject(z.VIDEO_STREAM_NOT_AVAILABLE);else c.resolve(m);return c.promise}function L(){A.getCallBackUrlForMessage()({chatType:z.CAMERA_UNAVAILABLE})}function J(b){var c=p.getCanvasById("webRTCWebcamImage");c.width=Math.min(b.videoWidth||320,320);c.height=Math.min(b.videoHeight||
240,240);c.getContext("2d").drawImage(b,0,0,c.width,c.height);k.info("Captured image using webRTCWebcamService");return p.compressImage(c,"camera")}function M(b){b||(b=0);var c=e.defer();B().then(function(e){var h=A.getCallBackUrlForMessage();e=J(e);x(e)||h({chatType:z.CAMERA_UNAVAILABLE});!e||1024>e.length?(k.log("Image size is not correct.",e),1<=b?c.reject("Error in image size"):M(b+1).then(c.resolve,c.reject)):c.resolve(e.replace("data:image/jpeg;base64,",""))});return c.promise}function t(b){DetectRTC.browser.isSafari?
(b.play(),h(b)):b.load()}function h(c){C=b(function(){var b=c.play();void 0!==b&&b.then(function(){k.log("video playing in video element");h(c)},function(b){k.error(b)})},2E4)}var z=c.CameraUtil,H,E,y,C,G;this.captureImage=M;this.checkForWorkingCamera=function(){var c=e.defer();B().then(function(e){H=J(e);b(function(){E=J(e);b(function(){y=J(e);b(function(){x(J(e))?c.resolve():c.reject({chatType:z.CAMERA_UNAVAILABLE})},300)},300)},400)});return c.promise};this.stop=function(){var c=e.defer();B().then(function(e){e.onended=
angular.noop;c.resolve();e.remove();C&&b.cancel(C)},c.reject);return c.promise}}]);