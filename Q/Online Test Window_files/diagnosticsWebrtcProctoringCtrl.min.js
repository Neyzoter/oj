define2("services/proctoring/proctoringFactory services/diagnosticService services/errorLogService services/diagnosticsConstants constants/proctoringConstants services/authorizationDataService services/testWindowConstants".split(" "),function(){angular.module("mettl").register.controller("DiagnosticsWebrtcProctoringCtrl",["$scope","$timeout","$log","$q","$http","TestWindowConstants","DiagnosticsConstants","ProctoringConstants","DiagnosticService","ProctoringFactory","ErrorLogService","AuthorizationDataService",
function(a,h,c,y,z,A,n,B,D,g,k,s){function t(){a.diagnostics.failed=!0;a.diagnostics.tmpl=d.pendingWebRTCPermissions}function u(a){if(a.type==d.multipleWebCam){for(var e={webcams:[]},p=0;p<a.data.length;p++)e.webcams.push(a.data[p]);v(e)}else a.type==d.screenPermission?(c.log("Screen diagnostics notify event arrived, for permission screen"),f(d.screenPermission)):a.type==d.screenDiagnosticsSuccess?(c.log("Screen diagnostics success event arrived, proceeding to camera diagnostics"),f(d.pendingWebRTCPermissions)):
a.type==d.pendingWebRTCPermissions?(c.log("Web rtc permission notification event arrived"),f(d.pendingWebRTCPermissions)):a.type==d.audioPermissionNotGranted?(c.log("Audio Permission not given  notification event arrived"),f(d.audioPermissionNotGranted)):c.info("WebRTC missed notification",a)}function q(b){try{c.info("Diagnostics error! Showing error template",b),k.log(b,!0),"object"==typeof b.data&&b.data.showCameraError||(f(b.type),DetectRTC&&(a.incognito=DetectRTC.browser.isChrome&&DetectRTC.browser.isPrivateBrowsing))}catch(e){c.log("error occurred while displaying error template",
e)}l.reject(b)}function r(){"NONE"==a.opts.mediaQuestionType&&(a.diagnostics.failed=!1,a.diagnostics.tmpl="",a.startCommonSlider=!0);s.setCandidateRunningWebRTC(!0);l.resolve()}function w(){if(a.opts.proctoringSettings.screenCapture&&"chrome"==a.opts.browserName){f(d.screenPluginHideSecurityBar);var b=h(r,3E4);a.proceedDiagnostics=function(){h.cancel(b);r()}}else r()}function f(b){h(function(){a.diagnostics.failed=!1;a.diagnostics.tmpl=""},1);h(function(){a.diagnostics.failed=!0;a.diagnostics.tmpl=
b},10)}function v(b){f(d.multipleWebCam);c.info("Displaying multiple webrtc webcam interface",b);var e=[];angular.forEach(b.webcams,function(a){e.push(a.label)});a.webCams=e;a.webCamSelection={value:-1};a.showWebRTCWebcam=!0;a.disableWebcamSelectionButton=!1}function x(b){c.log("Install browser plugin call arrived with ",b);g.installBrowserPlugin(b).then(function(){c.log("plugin installed successfully, now running diagnostics again");window.location.reload()},function(e){c.log("Error while installing plugin",
e);f(d.screenPluginManualInstallation);a.browserPluginStoreUrl=b})}function C(a){try{navigator.geolocation.getCurrentPosition(function(c){k.log("Candidate ID: "+a+" | Latitude, Longitude : "+c.coords.latitude+", "+c.coords.longitude+"| machine date :"+new Date,!0)},function(c){k.log("Candidate ID: "+a+" didn't share his location | machine date :"+new Date,!0)})}catch(c){k.log("Exception while tracking location of ciid :"+a,!0)}}var d=n.exceptionIndex;n=B.AppletMessageType;var m={},l;a.intallFirefoxScreenCapturingExtension=
function(){var a=conf.getFirefoxScreenPluginUrl();x(a)};a.intallChromeScreenCapturingExtension=function(){var a="https://chrome.google.com/webstore/detail/"+conf.getChromeScreenPluginId();x(a)};a.updateChromeScreenCapturingExtension=function(){var b="https://chrome.google.com/webstore/detail/"+conf.getChromeScreenPluginId();g.updateBrowserPlugin(b).then(function(){c.log("plugin updated successfully, now running diagnostics again");window.location.reload()},function(){f(d.screenPluginManualInstallation);
a.browserPluginStoreUrl=b})};a.copyPluginUrl=function(){try{document.getElementById("copyToClipBoardText").select(),document.execCommand("copy")&&(a.copySuccessful=!0)}catch(b){c.log("Oops, unable to copy")}};a.$on(n.SHOW_WEBRTC_FOR_MULTIPLE_WEB_CAM,function(a,c){v(c)});a.setAuthenticationDetails=function(){s.setAuthenticationDetails(m,angular.fromJson(m.crfs),a.opts)};a.webCamChanged=function(b){a.webCamSelection.value=b;a.disableWebcamSelectionButton=!0;a.showCameraSelectionError=!1;a.showWebRTCWebcam=
!1;c.log("Selected webcam: ",b);b={index:b,videoElement:document.getElementById("webRTCWebcam")};g.startVideoStreamByIndex(b,function(){a.showWebRTCWebcam=!0;a.disableWebcamSelectionButton=!1;a.showCameraSelectionError=!1},function(b){a.showWebRTCWebcam=!1;a.disableWebcamSelectionButton=!0;a.showCameraSelectionError=!0;q(b)})};a.finalWebCamSelection=function(){a.diagnostics.failed=!1;a.diagnostics.tmpl="";g.resumeDiagnosticsAfterCameraSelection().then(w,q,u)};a.showPendingWebRTCTemplate=t;a.runWebRTCDiagnostics=
function(){l=y.defer();a.opts.proctoringSettings.screenCapture?(a.diagnostics.failed=!0,a.diagnostics.tmpl=d.firstScreen):t();g.runDiagnostics(a.opts,!0,a.opts.proctoringSettings.screenCapture,conf.getChromeScreenPluginId(),!1).then(function(a){c.log("success in webSocket diagnostics");w()},function(a){c.log("error in webSocket diagnostics",a);q(a)},function(a,c){u(a,c)});return l.promise};(function(){a.isAPI&&z.post(A.Url.retrieveCandidateDetails,{ciid:a.opts.ck}).then(function(b){a.isRequiredProctoringDataLoaded=
!0;m=b.data;C(m.candidateInstanceId)},a.loadingError)})()}])});