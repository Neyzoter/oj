define2("services/validationService services/testWindowFactory services/testWindowConstants services/angularAjaxTransformService services/authorizationDataService services/resourceLoaderService".split(" "),function(){angular.module("mettl").register.service("RegistrationService",["$http","$log","$q","ValidationService","TestWindowFactory","TestWindowConstants","transformRequestAsFormPost","AuthorizationDataService","ResourceLoaderService",function(k,n,p,e,h,l,C,q,v){function w(a,b,c){return{ik:h.test.getInvitationKey(),
canResume:r,candidateData:a,consentId:b,candidateContextData:c}}function x(a){var b=0,c;for(c in a)a.hasOwnProperty(c)&&b++;return b}function s(a){var b=!0;angular.forEach(a,function(a){var d=t(a);if(d){if(3===a.FieldType){var f;f=a.date?a.date.day+"/"+a.date.month+"/"+a.date.year:void 0;a.value=f}}else 3===a.FieldType&&delete a.value;b=d&&b});return b}function t(a){if(1==a.RegistrationFieldID){if(e.validateEmail(a.value))return delete a.error,!0;a.error=window.RGTN_ERR_INVALID_EMAIL||"Enter valid email";
return!1}if(2==a.RegistrationFieldID){if(e.validateName(a.value))return delete a.error,!0;a.error=window.RGTN_ERR_INVALID_NAME||"First name is required";return!1}switch(a.FieldType){case 1:if((a.IsNecessary||a.IsResubmitNecessary)&&e.isEmpty(a.value))return a.error=window.RGTN_ERR_INVALID_VALUE||"Enter a valid value",!1;delete a.error;return!0;case 2:if((a.IsNecessary||a.IsResubmitNecessary)&&e.isEmpty(a.value))return a.error=window.RGTN_JSM_CHOOSE_OPTION||"This field is required",!1;delete a.error;
return!0;case 3:if(!a.IsNecessary&&!a.IsResubmitNecessary&&(void 0==a.date||e.isEmpty(a.date.day)&&e.isEmpty(a.date.month)&&e.isEmpty(a.date.year)))return!0;if(void 0!=a.date&&e.validateDate(a.date.day,a.date.month,a.date.year))return delete a.error,!0;a.error=window.RGTN_ERR_INVALID_DATE||"Enter valid date";return!1;case 4:if((a.IsNecessary||a.IsResubmitNecessary)&&e.isEmpty(a.value))return a.error=window.RGTN_ERR_INVALID_IMAGE||"Please upload a image file",!1;delete a.error;return!0}}function u(a){for(var b=
!1,c=0;c<a.length;c++)if(4==a[c].FieldType){b=!0;break}b&&v.preLoadFileUploadPlugins()}function y(a,b){var c=p.defer();k({url:String.format(l.Url.candidateFetchCRFsUrl,a),cache:!0}).success(function(a,f,z,e){n.log(a);g=angular.fromJson(a.CRFsJSON);b.CRFs=g;b.ConsentMessage=a.ConsentMessage;b.ClientName=a.ClientName;b.ConsentId=a.ConsentId;b.ConsentEnabledFlag=a.ConsentEnabledFlag;u(g);c.resolve(b)}).error(function(a,f,z,e){400===f?(g=A,r=!0,b.success=!1,b.CRFs=g,b.canResume=!0,c.resolve(b)):401===
f?c.resolve({error:angular.fromJson(a.error).error}):c.resolve({error:"There seems to be some issue with your network connectivity. Please check your internet connection and then re-launch the test."})});return c.promise}function B(a){var b=q.getAuthorizationResponse();if(null!=b){var c=decodeURIComponent(b.data.crfs).split(",");n.log("requested again CRFs are ",c);angular.forEach(a,function(a){void 0!=_.find(c,function(c){return c==a.DisplayName})?(a.IsRequestedField=!0,a.IsDisable=!1,a.IsResubmitNecessary=
!0):(a.IsDisable=!0,a.IsRequestedField=!1,a.IsResubmitNecessary=!1)})}return a}var g=[],A=[{DisplayName:window.RGTN_BTN_TEXT_EMAIL_ADDRESS||"Email address",FieldType:1,IsCompulsory:!0,IsDisplay:!0,IsNecessary:!0,IsValidate:!1,Order:1,RegistrationFieldID:1,Status:1}],m=void 0,r=!1;this.monthsList=function(){m||(m=[],angular.forEach(REG_DATE_MONTHS.split(","),function(a,b){m.push({index:b+1,name:a})}));return m};this.validateFieldFromType=t;this.getCRFs=function(){var a={CRFs:g,success:!0,isWaitToResumePage:!1},
b=h.test.getInvitationKey();if(!b)return a=p.defer(),a.reject({exception:"Invalid test key"}),a.promise;var c=p.defer();q.isResubmitRequested()?(n.log("This is resubmit request, returning old CRFs here"),g=B(g),a.CRFs=g,u(g)):a=y(b,a);c.resolve(a);return c.promise};this.preValidateCandidate=function(a,b,c){h.test.getInvitationKey();var d={},f;angular.forEach(a,function(a){a.IsValidate&&(d[a.RegistrationFieldID]=a.value);1===a.RegistrationFieldID&&(f=a.value)});0!=x(d)||b?k.post(l.Url.candidatePreValidateCandidateUrl,
{ik:encodeURIComponent(h.test.getInvitationKey()),e:f,f:d,cpik:encodeURIComponent(b)}).success(function(b,d,f,e){b.FieldsMap=b.FieldsMap||{};angular.forEach(a,function(a){var c=b.FieldsMap[a.RegistrationFieldID];c?a.error=window[c]||c:delete a.error});c(b.Success)}).error(function(a,b,d,f){c(!0)}):c(!0)};this.validateCandidateData=s;this.registerCandidate=function(a,b,c,d){s(a)&&k({method:"post",url:l.Url.candidateRegistrationUrl,data:w(a,b,d)}).success(function(a,b,d,e){c({status:b,data:a})}).error(function(a,
b,d,e){c({status:b,data:a})})};this.checkCandidateForIdleState=function(){return k({url:l.Url.candidateStateUrl+"?c\x3d"+encodeURIComponent(h.test.getCandidateKey())+"\x26_\x3d"+(new Date).getTime(),method:"GET"})};this.sendResumeRequest=function(){return k.post(l.Url.resumeRequestUrl,{c:encodeURIComponent(h.test.getCandidateKey())})};this.populateCRFValuesForApiCandidate=function(a,b){angular.forEach(a,function(a){var d=b.fieldValues[a.RegistrationFieldID],f=!e.isEmpty(d)&&"null"!=d;a.HidePrefilled=
!a.IsNecessary||a.IsNecessary&&f;f&&(3==a.FieldType?(d=d.split("/"),a.date={},a.date.day=parseInt(d[0]),a.date.month=parseInt(d[1]),a.date.year=parseInt(d[2])):a.value=d)})}}])});