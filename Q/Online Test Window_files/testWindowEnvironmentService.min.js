define2("services/testWindowFactory services/testWindowTimerService services/testWindowHelperService services/testWindowConstants services/testWindowTestStateService services/testWindowQuestionService services/testWindowSectionService services/testWindowServerUtilsService services/testWindowCommonUtils services/testWindowConstants services/sebConnectionService services/navigationControlService".split(" "),function(){angular.module("mettl").register.service("TestWindowEnvironmentService",["$rootScope",
"TestWindowFactory","TestWindowTimerService","TestWindowHelperService","TestWindowConstants","TestWindowTestStateService","TestWindowQuestionService","TestWindowSectionService","$log","$q","$state","TestWindowServerUtilsService","TestWindowCommonUtils","SEBConnectionService","NavigationControlService",function(h,t,n,v,d,b,I,w,k,J,K,m,f,L,x){var c=v.Dialogue,g=d.TestFinishMode,y=new Date,z=!1,A=!1;return new function(){function B(){b.testState.isPractiseTest&&(y=new Date,C())}function C(){var a=parseInt(((new Date).getTime()-
y.getTime())/1E3/60);$("#last-saved").html(a);setTimeout(C,6E4)}function M(){var a=$("#testTimeBox"),b=$("#notification-wrapper");a.addClass("about-to-finish pull-left");b.slideDown();setTimeout(function(){b.slideUp();a.css("text-decoration","none")},1E4)}function r(a){f.syncParent("testFinished",{});b.testState.showResult||b.testState.showReport?K.go(d.Url.resultPageUrl):setTimeout(function(){cn.neyzoter.test.isMSB()?""!=b.redirectUrl&&"/"!=b.redirectUrl?L.sendMessage({clientId:b.candidate.clientId,link:b.redirectUrl,
message:d.SEB.OPEN_LINK_DEFAULT_BROWSER}).then(function(){f.closeWindow();window.location="https://tests.mettl.com/msb_exit"},function(a){k.error("error in sending message to seb web socket "+a.message);D()}):(f.closeWindow(),window.location="https://tests.mettl.com/msb_exit"):""!=b.redirectUrl&&"/"!=b.redirectUrl&&(b.isApi||b.isPrivateInviteLink)?D():(f.closeWindow(),c.Show({title:TEST_FINISH_TEST_TITLE,message:TEST_FINISH_MSG_6,type:c.Type.TEST_FINISH_WINDOW_CLOSE_FAILED,priority:c.Priority.TEST_END,
backgroundColor:"#000",opacity:"1",callback:function(a){k.log("test finished")}}))},a?500:1)}function D(){setTimeout(function(){window.onbeforeunload=angular.noop;window.location=b.redirectUrl},20)}function N(a){var l=b.testState.testEndingMode;if(l!=g.Finish){c.Refresh();var e=TEST_FINISH_MSG_1;switch(l){case g.ProctoredFinish:e=TEST_FINISH_MSG_2;break;case g.BrowsingToleranceExceeded:e=TEST_FINISH_MSG_3;break;case g.Timeout:e=TEST_FINISH_MSG_4;break;case g.SoftwareDetected:e=a.message}c.Show({title:a.title,
message:e,type:a.dialogueType,priority:a.dialoguePriority,backgroundColor:"#000",opacity:"1",actions:0==a.actions.length?[RR_BTN_CLOSE]:a.actions,fontWeight:a.fontWeight||"",width:a.width||"",callback:function(a){r()}})}else c.Show({title:TEST_FINISH_SUCCESS_TITLE,message:TEST_FINISH_SUCCESS_MSG,type:c.Type.TEST_FINISH_SUCCESSFULLY,call:"thankYou",priority:c.Priority.TEST_END,backgroundColor:"#000",opacity:"1",callback:function(a){k.log("test finished");r(!0)}})}function p(a,c,e,d){this.dialogueType=
a||"";this.dialoguePriority=c||null;this.title=e||"";this.message=d||"";this.actions=[];this.isSend=!b.testState.isPreview}function E(a,l){x.isNavigationAllowed(d.NavigationAway.AUTO_FT).then(function(){b.testState.testEndingMode=a;b.testState.isTestEnding=!0;var e={};switch(a){case g.Finish:e=new p(c.Type.TEST_FINISH_AFTER_CONFIRM,c.Priority.TEST_END,TEST_FINISH_TEST_TITLE,TEST_FINISH_TEST_MSG);break;case g.ProctoredFinish:e=new p(c.Type.PROCTOR_EXCEED,c.Priority.PROC_EXCEED,TEST_FINISH_BY_ADMIN_TITLE,
TEST_FINISH_BY_ADMIN_MSG);break;case g.BrowsingToleranceExceeded:e=new p(c.Type.PROCTOR_EXCEED,c.Priority.PROC_EXCEED,TEST_FINISH_NAV_EXCEEDED_TITLE,TEST_FINISH_NAV_EXCEEDED_MSG);break;case g.Timeout:e=new p(c.Type.TEST_TIMEOUT,c.Priority.TEST_TIMEOUT,TEST_FINISH_TIME_UP_TITLE,TEST_FINISH_TIME_UP_MSG);break;case g.SoftwareDetected:e=new p(c.Type.SOFTWARE_DETECTED,c.Priority.SOFTWARE_DETECTED,l.softwareName+" detected running!","\x3cp\x3eFinishing your test!\x3c/p\x3e\x3cp\x3eOur system has detected "+
l.softwareName+" running on your computer. This implies that you were cheating hence we are ending your test.\x3c/p\x3e"),e.softwareName=l.softwareName}k.log("Ending Test : type- "+e.dialogueType+" priority- "+e.dialoguePriority);b.testState.isPreview?(q(e),setTimeout(function(){f.closeWindow()},3E3)):($(".chatOutCont").hide(),w.updateTimeTakenForSection(b.sectionState.current),I.saveLastItem(),s(),h.$broadcast("cn.neyzoter.test.shutdown"),q(e),f.syncParent("testFinished",e))})["catch"](function(a){k.error("Navigation not allowed in case of Auto FT. Error: ",
a)})}function q(a){c.Refresh();c.Show({title:a.title,message:a.message,type:a.dialogueType,priority:a.dialoguePriority,backgroundColor:"#000",opacity:"1",actions:a.actions,callback:function(c){"Retry"==c?(a.isSend=!0,q(a)):"Try Again"==c?(a.isSend=!0,b.retry.OnFinishTest.Refresh(),q(a)):c==RR_BTN_CLOSE&&f.closeWindow()}});a.isSend&&(0<b.testState.PendingPromises.length?J.all(b.testState.PendingPromises).then(function(){u(a)},function(b){k.error("Error in exexuting pending promises. Err: ",b);u(a)}):
u(a))}function u(a){var b=t.getOptimizedJsonData(d.PR_SOURCE.FINISH_TEST,n.GetTestTime(),!0);v.AJAX({url:"/ft",data:b,timeout:6E4,success:function(b){s();a.isSend=!1;setTimeout(function(){N(a)},3E3)},error:function(b,d,l){s();a.isSend=!1;c.ShowAlert({title:a.title,message:c.GetTemplate("finishtest-network-error-template"),type:a.dialogueType,priority:c.Priority.ERROR,problem:"network",opacity:"1",call:"FTfail",callback:function(){a.isSend=!0;c.Hide();q(a)},actions:a.actions})}})}function F(){b.testState.isTestProctorPaused||
(b.testState.isTestProctorPaused=!0,x.isNavigationAllowed(d.NavigationAway.PROCTOR_PAUSED).then(function(){n.Stop();c.Show({title:TEST_POPUP_PAUSED_TITLE,backgroundColor:"black",message:TEST_POPUP_PAUSED_MESSAGE,type:c.Type.TEST_PAUSED,priority:c.Priority.TEST_PAUSED,width:60});m.syncWithServer(d.PR_SOURCE.TEST_PAUSED);m.serverSync.Disable();f.syncParent("testPause",{})})["catch"](function(a){k.error("Navigation not allowed in case of proctor pause. Error: ",a)}))}function s(){n.Stop();b.sectionState.timedOut.get(b.sectionState.currentIndex)&&
$("#section-timer").tickTock("destroy");m.serverSync.Disable();b.testState.isTestPaused=!0}function G(){m.serverSync.Enable();f.syncParent("testInProgress",{});b.sectionState.timedOut.get(b.sectionState.currentIndex)?w.timeOutSection(b.sectionState.currentIndex):n.Start();b.testState.isTestPaused=!1}function O(){h.$on(d.Events.Section.TimerStarted,function(a,d){b.testState.isTestProctorPaused&&(c.HideSpecific(c.Type.TEST_PAUSED),b.testState.isTestProctorPaused=!1,F())});h.$on(d.Events.Test.PauseTest,
s);h.$on(d.Events.Test.UnPauseTest,G);h.$on(d.Events.Server.PRSyncSuccess,B);h.$on(d.Events.Test.TestExpired,r);h.$on(d.Events.Test.EndTest,function(a,b){H(b.mode,b.data)})}function H(a,c){!A&&b.testState.isTestStarted&&(b.testState.isPreview?setTimeout(function(){f.closeWindow()},4E3):(A=!0,E(a,c)))}return{afterTestStart:function(){b.testState.isPreview||(m.serverSync.Enable(),O());var a=new Date;$("#test-start-time").empty().html(a.toLocaleDateString()+", "+a.toLocaleTimeString());n.Initialize({test:!0,
startNow:!1,onPromptTime:M,onExpiry:function(){z?k.error("Test has already expired."):(z=!0,b.PRSource=d.PR_SOURCE.TEST_TIME_OUT,E(g.Timeout))},time:cn.neyzoter.test.getDuration()});b.testState.isTestStarted=!0;b.testState.isTestDisplayed=!0;B();b.retry.OnStartTest.Retrying&&b.retry.OnStartTest.Refresh();f.syncParent("testInProgress",{})},onProctorPause:F,onProctorResumeCallBack:function(a){b.testState.isTestProctorPaused&&(b.testState.isTestProctorPaused=!1,G(),h.$broadcast(d.PR_SOURCE.TEST_RESUMED,{currentQid:b.sectionState.current.CurrentItem.Question.QuestionID}),
m.syncWithServer(d.PR_SOURCE.TEST_RESUMED),h.$broadcast("cn.neyzoter.test.resume",a))},onProctorResume:function(a){c.HideSpecific(c.Type.TEST_PAUSED);c.ShowAlert({title:TEST_POPUP_RESUME_TITLE,message:TEST_POPUP_RESUME_MESSAGE,width:60,actions:[],call:"ProctorResumeTest",backgroundColor:"black",data:a,priority:c.Priority.TEST_PAUSED})},EndTest:H,onTestFinishedAlready:r}}}])});