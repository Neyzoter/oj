define2("services/registrationService services/testWindowConstants services/testWindowTestStateService services/authorizationDataService directives/testWindowDirectives services/testWindowFactory services/testWindowCommonUtils services/testWindowHelperService ../constants/proctoringConstants".split(" "),function(){angular.module("mettl").register.controller("RegistrationCtrl",["$scope","$log","$state","$timeout","$window","$controller","$injector","RegistrationService","TestWindowConstants","AuthorizationDataService",
"TestWindowFactory","TestWindowHelperService","TestWindowCommonUtils","ProctoringConstants",function(a,d,g,v,D,r,w,k,n,f,l,x,p,y){function s(b){for(var h,c=0;c<a.CRFs.length;c++){var e=a.CRFs[c];if(e.RegistrationFieldID==b){h=e;break}}return h}function z(b,h){var c="";switch(b){case 1:c=window.FILE_TYPE_ERROR||"Not supported image file";break;case 2:c=window.MIN_FILE_SIZE_ERROR||"File size too small";break;case 3:c=window.MAX_FILE_SIZE_ERROR||"File size is greater than 5mb";break;default:c=window.FILE_OTHER_ERROR||
"Error in uploading file"}a.$apply(function(){h.error=c})}function A(a,h){return/\.(jpg|jpeg|png|gif)$/i.test(a.name.toLowerCase())?1024>=a.size?2:5242880<a.size?3:!1:1}function B(){a.candidatePreVerificationInProgress&&require2(["controllers/candidatePreRegistrationCtrl"],function(){r("CandidatePreRegistrationCtrl",{$scope:a})});k.getCRFs().then(function(b){if(b.success||b.canResume)a.CRFs=b.CRFs,a.ConsentMessage=b.ConsentMessage,a.ClientName=b.ClientName,a.ConsentId=b.ConsentId,a.ConsentEnabledFlag=
b.ConsentEnabledFlag;a.canResume=b.canResume;a.opts.apiCandidateCrfs&&k.populateCRFValuesForApiCandidate(a.CRFs,a.opts.apiCandidateCrfs);p.syncParent("testRegistration")},function(b){d.error(b);b.exception?(d.log("redirecting to diagnostics"),g.go("diagnostics")):b.error?a.error=b.error:500==b.status?g.go("error"):(d.log("unhandled error in fetch CRFs call"),m())});if(f.isResubmitRequested()){var b=f.getAuthorizationResponse();a.resubmitPendingFields=b.data;a.resubmitPendingFields.comment=b.comments;
a.onlineAdmins=f.getOnlineAdmins();a.uniqueId=f.getCandidateId();a.groupId=cn.neyzoter.test.getMpsCandidateInfo().groupId}a.opts.onAppletFallback&&require2(["controllers/appletErrorCtrl"],function(){r("AppletErrorCtrl",{$scope:a})})}function m(){x.Dialogue.ShowNetworkDisconnectionBeforeST(function(){window.location.reload()})}function t(b){d.log(b);a.hasError=!0;a.isProcessingCRFs=!1;b&&b.data&&(a.error=b.data.error?b.data.error:RGTN_ERR_WHILE_VALIDATING);a.error==RGTN_ERR_TEST_COMPLETED?p.syncParent("testAlreadyTaken"):
"AUTH_BLOCK_MSG_1"==a.error?p.syncParent("authorizationDenied"):a.error&&""!=a.error||m()}function C(){d.info("Registration successful, going to test window with ciid \x3d ",cn.neyzoter.test.getCandidateKey());var a=!1;l.load().then(function(){a=!0;g.go(n.Url.startTestUrl)},function(a){d.error("Error in load test",a);m()});v(function(){a||m()},18E4)}function u(b){if(b.data.error)b.data.waitToResume?(b=b.data,a.opts.waitToResume=!0,a.opts.isInProgress=b.isInProgress,a.opts.isSupervisedSchedule=b.isSupervisedSchedule,
a.opts.isDuplicate=b.isDuplicate,a.isProcessingCRFs=!1,a.opts.visualProctoring?(f.setAuthenticationDetails(b,a.CRFs,a.opts),g.go(n.Url.authorization)):g.go(n.Url.resumePageUrl)):t(b);else{b=b.data;try{window.opener.Mettl.Parent.SetCandidateData(a.CRFs[0].value,encodeURIComponent(cn.neyzoter.test.getCandidateKey()))}catch(h){d.log(h.message)}a.opts.visualProctoring?(f.setAuthenticationDetails(b,a.CRFs,a.opts),g.go(n.Url.authorization)):C()}}if(a.$parent.initialised){a.$parent.showPrivacyPolicy=!0;a.hasError=
!1;a.error=null;a.isFinished=!1;a.isProcessingCRFs=!1;a.authorizationResponse=null;a.testName=cn.neyzoter.test.getTestName();a.months=k.monthsList();a.uploadingCRF=!1;a.candidatePreVerificationInProgress=!f.isResubmitRequested()&&(a.opts.isOTPProtected||a.opts.isCandidateCRFPrefilled);a.otpSent=!1;var q;a.closeWindow=function(){p.closeWindow()};a.uploadCRF=function(b){$(b.target).fileupload({url:"/uploadCRFFile",dataType:"json",add:function(b, c){var e=$(this),d=s(e.data("crf").RegistrationFieldID),e=c.originalFiles[0];
delete d.error;(e=A(e))?z(e,d):(c.formData={fileToReplace:d.fileToReplace||""},c.submit(),a.$apply(function(){delete d.value;delete d.fileToReplace;d.uploading=!0;a.uploadingCRF=!0}))},done:function(b,c){if(c||c.result){var e=c.result,f=s(c.crf.RegistrationFieldID);a.$apply(function(){e.success?(f.value=e.completeUrl,f.fileToReplace=e.key):f.error=window[e.errorMessage]||window.showFileUploadError||"Error in uploading file";for(var b=f.uploading=!1,c=0;c<a.CRFs.length;c++)if(a.CRFs[c].uploading){b=
!0;break}a.uploadingCRF=b})}else d.error("Error while uploading file"),m()},error:function(a,b,e){d.error("Error while uploading file"+e.message);m()}})};a.$on(y.AppletMessageType.SELF_OFFLINE,function(b,h){d.debug("Disconnected from servers while refilling data.");f.isResubmitRequested()&&(q||(q=w.get("ProctoringProviderFactory")),a.onlineAdmins={},f.setOnlineAdmins(a.onlineAdmins),q.getCommunicationProvider().reconnectAuthRequest())});B();a.validateFieldFromType=k.validateFieldFromType;a.handleRegistrationResponse=
u;a.submitRegistration=function(){a.isProcessingCRFs=!0;k.validateCandidateData(a.CRFs)?k.preValidateCandidate(a.CRFs,a.opts.candidatePrivateInviteKey,function(b){b?k.registerCandidate(a.CRFs,a.ConsentId,function(a){cn.neyzoter.test.setCandidateKey(a.data.ciid);switch(a.status){case 200:u(a);break;case 500:g.go("error");break;default:t(a)}},a.opts.candidateContextData):a.isProcessingCRFs=!1}):a.isProcessingCRFs=!1};a.range=function(a, d, c){c=void 0===c?1:c;for(var e=[]; a<=d; a+=c)e.push(a);return e};a.$on("$destroy",
function(){a.$parent.showPrivacyPolicy=!1})}else d.log("redirecting to diagnostics"),g.go("diagnostics")}])});