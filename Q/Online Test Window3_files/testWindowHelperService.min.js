define2(["services/testWindowConstants","services/testWindowTestStateService","services/testWindowCommonUtils"],function(){angular.module("mettl").register.service("TestWindowHelperService",["$rootScope","TestWindowConstants","TestWindowTestStateService","TestWindowCommonUtils","$log","$q","$timeout",function(k,h,m,n,p,r,s){var g,d=new function(){function t(b){switch(b){case "Retry":case "Try Again":b="Retrying";break;case "Start Test":b="Starting Test...";break;case "Start Practice Session":b="Starting Practice Session..."}return b}
function u(b){"thankYou"==b.call&&setTimeout(function(){b.callback()},3E3);"SectionOver"==b.call&&$("#section-timer").tickTock({time:m.testState.isSectionTimeOverAndResumed?6:15,startNow:!0,showSecondValueOnly:!0,onExpiry:function(){b.callback()}});if("ProctorResumeTest"==b.call){var e=function(){$(".modal ._tickTock").tickTock("destroy");d.Dialogue.Hide();$("body").trigger("onProctorResumeCallBack",b.data)};g.undelegate("._resume","click").delegate("._resume","click",function(){e()}).find("._tickTock").tickTock({time:10,
startNow:!0,showSecondValueOnly:!0,onExpiry:function(){e()}})}"network"==b.problem&&k.$broadcast(h.Events.Server.CheckNetwork,b);b.call==h.Events.InitSectionSelectors&&k.$broadcast(h.Events.InitSectionSelectors,{});g.undelegate(".btn","click").delegate(".btn","click",function(){var e=$(this),a=e.val()||e.text(),a=$.trim(a);e.attr("disabled",!0).val(t(a));b.callback(a,b)})}function q(b,e){return _.template($("#"+b).html(),e||{})}return{checkAnyUntimedSection:function(b){for(var e=!1,d=0;d<b.length;d++)if(0==
b[d].SectionDuration){e=!0;break}return e},Dialogue:new function(){function b(a,b){this.opts=a;this.type=a.type;this.index=b;this.priority=a.priority||100}var e=[],f=!1;return{Refresh:function(){e=[]},ShowConfirm:function(a){a.type=a.type||d.Dialogue.Type.CONFIRM;a.priority=a.priority||d.Dialogue.Priority.CONFIRM;a.actions=a.actions||[DIAG_CONFIRM_YES,DIAG_CONFIRM_NO];var b=a.callback;a.callback=function(a){d.Dialogue.Hide();b&&b(a)};this.Show(a)},ShowAlert:function(a){a.type=a.type||d.Dialogue.Type.ALERT;
a.priority=a.priority||d.Dialogue.Priority.MESSAGE;a.actions=a.actions||[RR_BTN_OK];a.message=a.message||"";a.keepAliveOnCallback=a.keepAliveOnCallback||!1;a.data=a.data||"";var b=a.callback;a.callback=function(c){a.keepAliveOnCallback||d.Dialogue.Hide();b&&b(c)};this.Show(a)},ShowRetry:function(a){a.type=a.type||d.Dialogue.Type.ALERT;a.priority=a.priority||d.Dialogue.Priority.RETRY;a.isRetry=!0;this.Show(a)},Show:function(a){var l=!1,c;for(c in e){var d=e[c];if(!$.isFunction(d)){if(d.type==this.Type.SECTION_SELECTOR){var f=
!0;if(null!=a.toStopTimer||void 0!=a.toStopTimer)f=a.toStopTimer;d.opts.callback({toStopTimer:f});e.splice(c,1);a.type==this.Type.NETWORK_PROBLEM&&s(function(){k.$broadcast(h.Events.Test.PauseTest,{})},500)}a.type!=this.Type.SECTION_SELECTOR||d.type!=this.Type.SECTION_CHANGE&&d.type!=this.Type.ALERT||e.splice(c,1);if(d.priority==a.priority&&a.priority==this.Priority.RETRY)d.opts=a,d.type=a.type,l=!0;else{if(a.priority==this.Priority.TEST_END||a.priority==this.Priority.PROC_EXCEED){e=[];break}if(d.type==
this.Type.WARNING&&a.type==this.Type.WARNING&&a.type!=this.Type.PROCTOR_EXCEED)d.opts=a,l=!0;else if(d.type==this.Type.CONFIGURE_CAMERA||d.type==this.Type.CAMERA_PROBLEM)d.opts=a,l=!0}}}l||(e.push(new b(a,e.length)),e.sort(function(a,c){return c.priority-a.priority}));this.Display()},ShowErrorMessage:function(a,b,c,e){d.Dialogue.Show({title:c||"Error",message:a,type:d.Dialogue.Type.ERROR,priority:d.Dialogue.Priority.ERROR,actions:e?[]:[RR_BTN_CLOSE],backgroundColor:"black",callback:function(){b&&
b()}})},ShowNetworkDisconnectionBeforeST:function(a,b){f||(f=!0,d.Dialogue.ShowAlert({title:b?"Error":"INTERNET CONNECTIVITY ISSUE!",message:b||"There seems to be some issue with your internet connectivity.",actions:["Reload Test"],backgroundColor:"#000",icon:"warning",callback:function(c){f=!1;a&&a(c)}}))},ShowServerErrorMessage:function(a,b,c){if(!c){if(f)return;f=!0}d.Dialogue.ShowAlert({title:"ERROR OCCURRED!",message:b?"Something went wrong. Please try again. If problem persists please close your test window and restart your test.":
"Something went wrong. Please try again. If problem persists please close your test window(do not press Finish Test button) and restart your test.",actions:["Try Again"],backgroundColor:"#fff",icon:"warning",callback:function(c){f=!1;a&&a(c)}})},Display:function(){var a=e[e.length-1],b=a.opts,c="",c=d.Dialogue.Type;switch(a.type){case c.ALERT:case c.SECTION_TIMEOUT:case c.TEST_START:case c.SECTION_INSTRUCTION:case c.CONFIGURE_CAMERA:c="information.png";break;case c.TEST_TIMEOUT:case c.SECTION_SELECTOR:c=
"clock.png";break;case c.CONFIRM:c="confirm.png";break;case c.SECTION_CHANGE:case c.TEST_FINISH_CONFIRM:case c.CAMERA_PROBLEM:case c.TEST_PAUSED:case c.REAL_TIME_TEXT_EVALUATION_ERROR:case c.TEST_SAVED:c="warning.png";break;case c.PROCTOR_EXCEED:case c.WARNING:c="proctoring.png";break;case c.SOFTWARE_DETECTED:c="suspiciousSoftware.png";break;case c.TIMER_DISCREPANCY:c="timer.png";break;case c.TEST_FINISH_AFTER_CONFIRM:c="stop.gif";break;case c.TEST_FINISH_WINDOW_CLOSE_FAILED:c="finish_test.png";break;
case c.TEST_FINISH_SUCCESSFULLY:c="success.png";break;case c.MULTIPLE_SCREEN_DETECTED:c="proctoring.png";break;case c.MSB_FORCE_UPDATE:c="msbUpdate.png";break;case c.MONITORED_SESSION:c="proctoring/red-dot-large.png";break;default:c="information.png"}b.icon=c;a=a.opts;b=992>$(window).innerWidth()?150:200;b=$(window).height()-b;c=a.message||"No specific instruction for this section";c.match(".*\\\x3c[^\x3e]+\x3e.*")||(console.log("instruction has no html charactor"),c="\x3cpre\x3e"+c+"\x3c/pre\x3e");
b={icon:a.icon||"information",title:a.title||"",message:c||"",actions:a.actions||[],modalClass:a.modalClass||"",backgroundClass:a.backgroundClass||"",modalBodyMaxHeight:b};g&&g.modal("hide").remove();b=q("dialogue-content-box",b);g=$(b);g.modal({backdrop:"static",keyboard:!1});$(document).off("focusin.modal");u(a)},Hide:function(){m.onAnyRetry()||(e.pop(),e.length?this.Display():g.modal("hide").remove())},HideSpecific:function(a){var b=!1,c;for(c in e)if(e[c].type==a){e.splice(c,1);b=!0;break}b&&
(e.length?this.Display():g.modal("hide").remove())},Type:{SHOW:1,ALERT:2,CONFIRM:3,SECTION_SELECTOR:4,SECTION_INSTRUCTION:5,WARNING:6,SECTION_TIMEOUT:7,SECTION_CHANGE:8,TEST_TIMEOUT:9,TEST_FINISH_CONFIRM:10,TEST_FINISH_AFTER_CONFIRM:21,TEST_FINISH_WINDOW_CLOSE_FAILED:22,TEST_FINISH_SUCCESSFULLY:23,TEST_START:11,PROCTOR_EXCEED:12,CONFIGURE_CAMERA:13,CAMERA_PROBLEM:14,TEST_PAUSED:15,DB_SCHEMA:16,NETWORK_PROBLEM:17,ERROR:18,SOFTWARE_DETECTED:19,TIMER_DISCREPANCY:20,FILE_UPLOAD:21,REAL_TIME_TEXT_EVALUATION_ERROR:24,
MULTIPLE_SCREEN_DETECTED:25,MSB_FORCE_UPDATE:26,CLOSE_WINDOW:99,TEST_SAVED:26,THINKING_TIME_IN_PROGRESS:2,MEDIA_RECORDING_IN_PROGRESS:3,MIN_QUESTION_TIME:2,MONITORED_SESSION:27},Priority:{CLOSE_WINDOW:-9,PROC_WARNING:-6,ERROR:-5,SOFTWARE_DETECTED:-4,PROC_EXCEED:-4,TIMER_DISCREPANCY:-4,MULTIPLE_SCREEN_DETECTED:-4,TEST_PAUSED:-3,TEST_TIMEOUT:-2,TEST_FINISH_CONFIRM:-1,CAMERA_PROBLEM:1,APPLET_PROBLEM:1,CONFIGURE_CAMERA:1,SHOW:2,RETRY:3,TEST_START:4,TEST_END:5,SECTION_TIMEOUT:6,SECTION_SELECTOR:7,CONFIRM:8,
MESSAGE:9,TEST_SAVED:-1,THINKING_TIME_IN_PROGRESS:8,MEDIA_RECORDING_IN_PROGRESS:8,MIN_QUESTION_TIME:8,MONITORED_SESSION:9},GetTemplate:q}},Log:function(b){p.log(b)},AJAXC:function(b){if(n.sendDataOnAUI())this.AJAX(b);else{var e=$("\x3cinput type\x3d'hidden' name\x3d'd' value\x3d'' /\x3e").val(n.htmlEncode(angular.toJson(b.data))),e=$("\x3cform /\x3e").append(e).serialize(),d=$.extend({type:b.method||"POST",contentType:"application/x-www-form-urlencoded; charset\x3dutf-8;",dataType:"json",success:function(){},
error:function(){}},b);d.data=e;d.url=conf.getPrServerUrl()+b.url;return $.ajax(d)}},AJAX:function(b){var e=r.defer(),d={type:b.method||"POST",contentType:b.contentType||"application/json; charset\x3dutf-8;",cache:!1,url:b.url,data:angular.toJson(b.data||{}),dataType:b.dataType||"json",async:b.async,global:b.global,success:function(a){b.success?b.success(a):e&&e.resolve(a)},error:function(a,d,c){b.error?b.error(a,d,c):e.reject([d,c])},beforeSend:b.beforeSend,complete:b.complete};b.timeout&&(d.timeout=
b.timeout);$.ajax(d);if(e.promise){e.promise.abort=function(){e.reject("abort")};if(angular.isFunction(e.promise["finally"]))e.promise["finally"](function(){p.info("Cleaning up object references.");e.promise.abort=angular.noop;e=null});return e.promise}}}};(function(){Date.prototype.format=function(){var d=this.getHours(),d=12<d?d-12:d;return(10>d?"0"+d:d)+":"+(10>this.getMinutes()?"0"+this.getMinutes():this.getMinutes())+" "+(12<=this.getHours()?"pm":"am")};k.$on(h.Events.Test.CloseIFRAMEWindow,
function(){m.testState.isTestEnding=!0;d.Dialogue.Hide();d.Dialogue.Show({title:"Close Browser",message:"Please close your browser, as we are unable to close your test window.",type:d.Dialogue.Type.CLOSE_WINDOW,priority:d.Dialogue.Priority.CLOSE_WINDOW,backgroundColor:"#000"})})})();return d}])});