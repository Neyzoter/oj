define2("services/testWindowConstants services/testWindowSectionFactory services/testWindowItemFactory services/testWindowFactory services/testWindowTestStateService services/testWindowHelperService services/testWindowEnvironmentService services/testWindowSectionService services/testWindowQuestionService services/ticktockService directives/testWindowDirectives directives/paginationFilterDirective directives/paginationCarouselDirective filters/testWindowFilters controllers/testWindowSectionCtrl services/gaService services/testWindowCommonUtils services/navigationControlService".split(" "),
function(){angular.module("mettl").register.controller("TestWindowCtrl",["$rootScope","$scope","$state","$controller","$timeout","$injector","TestWindowFactory","TestWindowEnvironmentService","TestWindowServerUtilsService","TestWindowSectionService","TestWindowQuestionService","TestWindowConstants","TestWindowHelperService","$log","TestWindowTestStateService","TestWindowCommonUtils","NavigationControlService","$q",function(n,a,k,v,p,y,h,w,z,A,G,c,e,q,f,r,t,C){function g(a){return parseInt(a,10)}function x(b,
d,D){t.isNavigationAllowed(c.NavigationAway.INSTRUCTION).then(function(){var c={message:d,actions:[RR_BTN_OK],modalClass:"modal-lg",callback:e.Dialogue.Hide};switch(b){case "currentSection":c.title=TEST_SECTION_INSTR_HEADER+" "+a.selectedSection.SectionName;c.priority=e.Dialogue.Priority.MESSAGE;c.type=e.Dialogue.Type.SECTION_INSTRUCTION;break;case "assessment":c.title=TEST_INSTRUCTION_HEADER;break;default:console.log("Invalid instruction type: ",b);return}e.Dialogue.Show(c);D()},function(a){q.log("Not able to show instructions.",
a)})}function B(){a.$emit(c.Events.Test.ShowSectionInstruction,{category:"buttonRR",action:"infoSection",data:{qIndex:g(a.$state.params.i),qNumber:g(a.$state.params.i)+1,filter:a.currentFilterName}})}function E(){a.$emit(c.Events.Test.ShowTestInstruction,{category:"buttonRR",action:"infoAssessment",data:{qIndex:g(a.$state.params.i),qNumber:g(a.$state.params.i)+1,filter:a.currentFilterName}})}function F(){var b=y.get("MediaQuestionService"),d;try{var c=a.opts.mediaQuestionType,g=f.candidate.id,h=parseInt(conf.audioDiagnosticBgPowThreshold)||
0,e=b.getIsDiagnosticForceProceed(),k;var l=b.getDiagnosticCarnegieData();if(l&&l.length){for(var p=y.get("MediaQuestionService"),n=[],m=0;m<l.length;m++){var r={shortParam:p.isAudioShort(l[m].status_bits),noisyParam:l[m].noisy,loudParam:l[m].loud,softParam:l[m].soft,bgPowParam:l[m].bgpow,status:l[m].status,rawResponse:JSON.stringify(l[m])};n.push(r)}k=n}else k=void 0;d={type:c,candidateInstanceId:g,data:{bgPowThreshold:h,isForceProceed:e,candidateAudioDiagnosticEvents:k}};var s=JSON.stringify(d.data);
d.data=s}catch(t){q.log("Error in preparing audio quality check data, Reason \x3e "+t.message);return}b.sendAudioQualityDataToServer(d)}var s="cn.neyzoter.test"!=a.opts.mode;a.showHeader=!0;a.isClientCalc=!1;a.isTaskBasedTest=a.opts.isTaskBasedTest;if(a.$parent.initialised||s){a.availableSelectWidth=110;s&&h.init(a.opts);n.$on(c.Events.InitSectionSelectors,function(b, d){$("#sectionSummary").undelegate("._section","click").delegate("._section","click",function(){var b=$(this).data("index");e.Dialogue.Hide();a.changeSection(b);
n.$emit(c.Events.Test.FinishSectionWindow,{category:"sectionTimeWindow",action:"SectionChange",data:{qIndex:f.itemState.currentIndex,qNumber:f.itemState.currentIndex+1,sIndexClicked:b}})})});var u={loadLogoPath:function(b){a.logopath=b&&b.LogoPath?conf.getStaticServerUrl()+"/logo/"+b.LogoPath:conf.getStaticServerUrl()+"/resources/images/mettl_beta.png"},resizeWindow:function(){var a=window,d=screen.availWidth||screen.width,c=screen.availHeight;c&&c!=screen.height||(c=screen.height-70);setTimeout(function(){try{a.moveTo(0,
0),a.resizeTo(d,c)}catch(g){q.log(g.message)}},400)},windowCrossed:function(b){if(f.testState.isTestStarted||!f.testState.isTestEnding){$("body").trigger("offRR");f.testState.crossClickAttempted=!0;var d=RR_TEST_CLOSE_MSG;"undefined"==typeof b&&(b=window.event);b&&(b.returnValue=d);a.$emit(c.Events.Server.PRSync,c.PR_SOURCE.WINDOW_CLOSED);setTimeout(function(){f.testState.crossClickAttempted=!1;a.$emit(c.Events.Server.PRSync,c.PR_SOURCE.WINDOW_CLOSED_CANCELLED)},3E3);return d}},bindEvents:function(){function b(){n.$broadcast(c.Events.OrientationChange,
{})}$(document).on("keydown",function(a){8!==a.which||$(a.target).is("input:not([readonly]):not([type\x3dradio]):not([type\x3dcheckbox]), textarea, [contentEditable], [contentEditable\x3dtrue]")||a.preventDefault();9==a.keyCode&&(f.testState.isTestPaused||f.testState.isTestProctorPaused)&&a.preventDefault()}).bind("cut copy paste",function(a){if("TS"!=f.itemState.current.DisplayType&&f.testState.isAllowCopyPaste){var b=$(a.target);(b.hasClass("_question-body")||0<b.parents("._question-body").length)&&
a.preventDefault()}else a.preventDefault()}).bind("onProctorResumeCallBack",function(a,b){w.onProctorResumeCallBack(b)}).bind("click",function(){a.$apply(function(){a.isNavVisible=!1;a.$broadcast(c.Events.Carousel.ToggleCarousel,{hideCarousel:!0})})});window.addEventListener&&(window.removeEventListener("orientationchange",b),window.addEventListener("orientationchange",b));window.onscroll=function(b){a.$apply(function(){a.isNavVisible=!1})};s||($(window).bind("beforeunload",u.windowCrossed),window.onunload=
function(a){f.testState.isTestEnding||r.syncParent("windowCrossed",{});f.testState.crossClickAttempted&&r.closeWindow()})}};s&&!r.isIE()&&u.resizeWindow();a.swipeQuestion=function(b,d){var c=$(d.target);if(c.hasClass("._msq-wrapper")||1==c.parents("._msq-wrapper").length)return d.stopPropagation(),!1;c=navigator.userAgent.toLowerCase();if(!/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(c)||"prev"==b&&a.isFirstQuestion||"next"==b&&a.isLastQuestion)return!1;a.toQuestion(b);d.stopPropagation()};
a.toQuestion=function(b){n.$broadcast(c.Events.Test.ToQuestion,{category:"buttonRR",action:b+"Question",data:{qIndex:g(a.$state.params.i),qNumber:g(a.$state.params.i)+1}});b=a.getPageNumber("next"==b);a.currentPaginationIndex=b;a.$broadcast(c.Events.Test.GoToQuestion,{num:b})};a.setDropDownSection=function(a){angular.forEach(document.getElementsByClassName("_ddlSectionSelector"),function(c){angular.element(c).scope().selectedSection=a})};a.changeSection=function(b){t.isNavigationAllowed(c.NavigationAway.SECTION).then(function(){return A.canChangeToSection(b)}).then(function(d){d?
(d=h.sections.getByIndex(g(k.params.s)),d.IsTimed&&(d.Status=c.Status.Completed),k.go("^.^.section",{s:g(b)})):a.setDropDownSection(a.prevSection)})["catch"](function(b){q.error("Error in section switching. Error: ",b);a.setDropDownSection(a.prevSection)})};a.nextSection=function(){var b,d=g(k.params.s),f=h.sections.getAll().length-1;if(d!=f){a.$emit(c.Events.Test.NextSection,{category:"buttonRR",action:"nextSection",data:{qIndex:g(a.$state.params.i),qNumber:g(a.$state.params.i)+1,filter:a.currentFilterName}});
for(var e=0,e=d+1;e<=f;e++)if(d=h.sections.getByIndex(e),!d.IsComplete()||!d.IsTimed){b=e;break}_.isUndefined(b)||a.changeSection(b)}};a.sectionSelectorClicked=function(){var b={qIndex:g(a.$state.params.i),qNumber:g(a.$state.params.i)+1,filter:a.currentFilterName};a.$emit(c.Events.Test.SectionSelectorClicked,{category:"buttonRR",action:"listSection",data:b})};a.previousSection=function(){var b,d=g(k.params.s);if(0!=d){a.$emit(c.Events.Test.PrevSection,{category:"buttonRR",action:"prevSection",data:{qIndex:g(a.$state.params.i),
qNumber:g(a.$state.params.i)+1,filter:a.currentFilterName}});for(var e=0,e=d-1;0<=e;e--)if(d=h.sections.getByIndex(e),!d.IsComplete()||!d.IsTimed){b=e;break}_.isUndefined(b)||a.changeSection(b)}};a.$on(c.Events.Section.ChangeSection,function(a,c,e){k.go("^.^.section",{s:g(c)})});a.askFinish=function(){t.isNavigationAllowed(c.NavigationAway.MANUAL_FT).then(function(){if(A.canFinishCurrentSection("f")){var b=h.getAttemptSummary();b.isFixedSectionOrder=cn.neyzoter.test.isFixedSectionOrder();b.isTaskBasedTest=
!1;e.Dialogue.ShowConfirm({message:e.Dialogue.GetTemplate("finish-test-template",b),title:TEST_FINISH_TEST_TITLE,actions:[BTN_CANCEL,BTN_FIN_TEST],type:e.Dialogue.Type.TEST_FINISH_CONFIRM,priority:e.Dialogue.Priority.TEST_FINISH_CONFIRM,call:c.Events.InitSectionSelectors,modalClass:"modal-lg",callback:function(a){var b="Cancel";a==BTN_FIN_TEST&&(f.PRSource=c.PR_SOURCE.FINISH_TEST,w.EndTest(c.TestFinishMode.Finish),b="Finish");n.$emit(c.Events.Test.FinishSectionWindow,{category:"sectionTimeWindow",
action:b,data:{qIndex:f.itemState.currentIndex,qNumber:f.itemState.currentIndex+1}})}});a.$emit(c.Events.Test.AskFinish,{category:"buttonRR",action:"finishTestMain",data:{qIndex:g(a.$state.params.i),qNumber:g(a.$state.params.i)+1,filter:a.currentFilterName}})}})["catch"](function(a){q.error("Finish test not allowed. Error: ",a)})};a.saveTask=function(){var b=C.defer();t.isNavigationAllowed(c.NavigationAway.QUESTION).then(function(){var b=h.getAttemptSummary();b.isFixedSectionOrder=cn.neyzoter.test.isFixedSectionOrder();
b.isTaskBasedTest=a.isTaskBasedTest;e.Dialogue.ShowConfirm({message:e.Dialogue.GetTemplate("finish-test-template",b),title:TEST_SAVE_TASK_TITLE,actions:[BTN_CANCEL,BTN_SAVE_TASK],type:e.Dialogue.Type.TEST_SAVED,priority:e.Dialogue.Priority.TEST_SAVED,modalClass:"modal-lg",callback:function(a){a===BTN_SAVE_TASK&&z.syncWithServer(c.PR_SOURCE.SAVE_TASK)}})},b.reject);return b.promise};a.showTestInstructions=function(){x("assessment",e.Dialogue.GetTemplate("testTakers-instruction-template",{instructions:a.testWindow.Assessment.AssessmentInstruction}),
E)};a.showCurrentSectionInstructions=function(){var b=a.selectedSection.Instruction||"No specific instruction for this section";b.match(".*\\\x3c[^\x3e]+\x3e.*")||(console.log("instruction has no html character"),b="\x3cpre\x3e"+b+"\x3c/pre\x3e");x("currentSection",b,B)};a.showInstructionForSmDevice=function(){var b=a.selectedSection.Instruction;if(b){var c=e.Dialogue.GetTemplate("testTakers-instruction-template",{instructions:a.testWindow.Assessment.AssessmentInstruction});x("assessment",e.Dialogue.GetTemplate("sm-instruction-template",
{aInstructions:c,sInstructions:b}),B)}else a.showTestInstructions()};a.toggleTabHeader=function(){a.showHeader=!a.showHeader};a.previewClose=function(){r.closeWindow()};a.showPrevSection=!1;a.showNextSection=!1;a.isLastSection=!1;a.isFirstQuestion=!0;a.selectedSection=void 0;a.sectionTimerEnabled=!1;a.$parent.isTestWindow=!0;a.currentTime=new Date;a.opts.isPractiseTest&&(a.onSave=function(){a.$broadcast("practice.save");p(function(){a.$emit(c.Events.Server.PRSync,c.PR_SOURCE.SAVE_TEST)},500)},a.onSaveAndClose=
function(){a.$broadcast("practice.saveAndClose");r.syncParent("saveAndclose");p(function(){a.$emit(c.Events.Server.PRSync,c.PR_SOURCE.SAVE_AND_CLOSE)},500)});a.afterLoadedTestdata=function(){a.isClientCalc=h.isAllowedNewCalculator();u.loadLogoPath(h.getThemeObj());var b=g(h.returnTwContent().state.currentSectionIndex);a.selectedSection=h.getTestWindowContent().Assessment.Sections[b];a.sectionTimerEnabled=a.selectedSection.IsTimed;a.prevSection=h.getTestWindowContent().Assessment.Sections[b];a.testWindow=
angular.extend(h.get(),h.getTestWindowContent());a.theme=h.getThemeObj();p(function(){w.afterTestStart();u.bindEvents();k.go(".section",{s:b});f.testState.visualProctoring?(v("WebProctoringCtrl",{$scope:a}),v("ProctoringCtrl",{$scope:a}),a.startProctoring(f.candidate)):f.testState.isWebProctored&&v("WebProctoringCtrl",{$scope:a});window.Mettl.initSupportNumber()},10);q.log("test window ctrl loading complete...")};s?h.load().then(function(){z.startPreviewTest().then(function(){a.afterLoadedTestdata()},
function(a){k.go("error");f.testState.isTestEnding=!0})},function(a){k.go("error");f.testState.isTestEnding=!0}):(a.afterLoadedTestdata(),"AUDIO"===a.opts.mediaQuestionType&&F());p(function(){angular.element('[data-toggle\x3d"tooltip"]').tooltip()});a.opts.visualProctoring&&(p(function(){angular.element("._monitoredSessionTooltip").tooltip("show")},1E3),p(function(){angular.element("._monitoredSessionTooltip").tooltip("hide")},1E4))}else q.log("redirecting to diagnostics"),k.go("diagnostics")}])});