define2(["services/testWindowConstants"],function(){angular.module("mettl").register.directive("carousel",["$stateParams","$rootScope","$window","TestWindowConstants","$location","$log","$q",function(t,n,p,l,G,H,I){return{restrict:"A",templateUrl:"/partials/paginationCarousel",link:function(a,v,q){function y(){z=$("._carousel").width()-125;g=parseInt(z/(99<k.length?50:45),10)||10;h=5<g?5:2;f=r=1;e=g;a.start=r;a.end=g;var b=$("._ddlSectionSelector").eq(0);setTimeout(function(){a.availableSelectWidth=
b.parent().width()-(b.siblings("._section-name").width()+b.siblings("i").width()+70)},5)}function A(){J()}function J(){window.clearTimeout(B);B=setTimeout(function(){a:{var b=$(document).scrollTop();if(0==b)a.pagination.current=w,angular.element("._question").addClass("ques-overlay"),$("._question[data-num\x3d"+a.pagination.current+"]").removeClass("ques-overlay"),m=1;else for(var c=angular.element("._question:not(.hide)"),d=0;d<c.length;d++)if(m=d+1,visibleQues=parseInt($(c[d]).data("num")),parseInt($(c[d]).position().top)>=
b||m==c.length){a.pagination.current=visibleQues;angular.element("._question").addClass("ques-overlay");$(c[d]).removeClass("ques-overlay");0<angular.element("._calculator").length&&($("._calc-main").removeClass("calc-show"),clearCalc());break a}else $(c[d]).addClass("ques-overlay"),$("._carousel li a[data-cindex\x3d"+a.pagination.current+"]").removeClass("active")}a.carousel.currentIndex=m;$("._currentQuesCount").text(m);$("._carousel li a").removeClass("active");$("._carousel li a[data-cindex\x3d"+
a.pagination.current+"]").addClass("active");if(e<m)for(b=Math.ceil((m-e)/g);b;)a.slideForward(),b--;if(f>m)for(b=Math.ceil((f-m)/g);b;)a.slideBackward(),b--;n.$broadcast(l.Events.Question.QuestionScrolled,{category:"questionPaginationRR",action:"questionScrolled",data:{qIndex:a.pagination.current-1,qNumber:a.pagination.current}})},10)}function K(){var b=0,c=x(a.pagination.current);_.each(s,function(a){a&&b++});a.carousel.questionCount=b;a.carousel.currentIndex=c;a.isFirstPage=1==f;a.isLastPage=e>=
a.carousel.questionCount;C(c,!1)}function D(a,c){s=a;K();n.$broadcast(l.Events.Pagination.AcknowledgeFilterChange,c)}function E(a){for(var c={},d=0;d<k.length;d++)switch(a){case "f":c[d+1]=k[d].IsFlagged;break;case "a":c[d+1]=k[d].IsAttempted&&!k[d].IsFlagged;break;case "u":c[d+1]=!k[d].IsAttempted&&!k[d].IsFlagged;break;default:c[d+1]=!0}return c}function C(b,c){if(!(c&&b>=f&&b<=e)){var d;d=b<=g?1:0==b%h?b-(g-1):Math.floor(b/h)*h-(g-h-1);f=d;d=b<=g?g:0==b%h?b:Math.floor(b/h)*h+h;e=d;e>a.carousel.questionCount&&
(e=a.carousel.questionCount,f=a.carousel.questionCount-(g-1));a.carousel.questionCount<=g&&(f=1,e=g);a.start=f;a.end=e;a.isFirstPage=f==r;a.isLastPage=e>=a.carousel.questionCount;n.$broadcast(l.Events.Pagination.Slide,{start:f,end:e})}}function x(a){var c=0,d=!1;_.each(s,function(e,f){d||(parseInt(f)==a&&(d=!0),e&&c++)});return c}if(a.section){var w,u;a.isMultipleQuestions=a.section.IsMultipleQuestions;if(a.isMultipleQuestions){angular.element(p).on("scroll",A);w=1;var B,m}else angular.element(p).off("scroll");
a.width=p.innerWidth;var k=a.section.Items,z,g,h,r,f,e;y();angular.element(p).bind("resize",function(b){y();a.$digest();if(a.isMultipleQuestions)if(992>document.documentElement.clientWidth)angular.element(p).off("scroll");else angular.element(p).on("scroll",A)});var s=E("all");a.Txt_Of=window.TXT_OF;v=a.section.CurrentItem;a.pagination={current:v.Index+1,flags:{},attempteds:{}};for(q=0;q<k.length;q++){var F=k[q];F.IsFlagged&&(a.pagination.flags[q+1]=!0);F.IsAttempted&&(a.pagination.attempteds[q+1]=
!0)}a.carousel={currentIndex:v.Index+1,questionCount:k.length};a.start=r;a.end=g;a.isFirstPage=!0;a.isLastPage=a.carousel.questionCount<=g;a.$parent.getPageNumber=function(b){var c=[];angular.forEach(s,function(a,b){a&&c.push(parseInt(b))});return b?c[a.carousel.currentIndex]:c[a.carousel.currentIndex-2]};a.slideForward=function(){a.isLastPage=!1;a.isFirstPage=!1;f+=h;e+=h;e>=a.carousel.questionCount&&(f=a.carousel.questionCount-(g-1),e=a.carousel.questionCount,a.isLastPage=!0);a.start=f;a.end=e;
n.$broadcast(l.Events.Pagination.Slide,{start:f,end:e,category:"questionPaginationRR",action:"scollerClickedForward",data:{qIndex:t.i,qNumber:t.i+1,scrollLabel:a.carousel.currentIndex+" of "+a.totalQuestions}})};a.slideBackward=function(){a.isLastPage=!1;a.isFirstPage=!1;f-=h;e-=h;f<=r&&(f=r,e=g,a.isFirstPage=!0);a.start=f;a.end=e;n.$broadcast(l.Events.Pagination.Slide,{start:f,end:e,category:"questionPaginationRR",action:"scollerClickedBack",data:{qIndex:t.i,qNumber:t.i+1,scrollLabel:a.carousel.currentIndex+
" of "+a.totalQuestions}})};a.isVisible=function(b){var c=x(b);return s[b]&&a.start<=c&&a.end>=c};a.openQuestion=function(b,c,d){var e=I.defer();if(Number(a.pagination.current)!==Number(b))return a.goToQuestion(b-1).then(function(){e.resolve();a.carousel.currentIndex=x(b);C(a.carousel.currentIndex,c);a.pagination.current=b;a.activeItem=u;if(!c)return!0;d&&d.stopPropagation();n.$broadcast(l.Events.Question.QuestionClicked,{category:"questionPaginationRR",action:"questionClicked",data:{qIndex:b-1,qNumber:b}})})["catch"](function(a){H.error("Error in opening question. Error: ",
a);e.reject(a)}),e.promise};a.scrollToQuestion=function(b,c){var d="ques"+b,e=angular.element("#"+d)[0].offsetTop-200;$("html, body").stop().animate({scrollTop:e},500);G.hash(d);a.pagination.current=b;a.section.CurrentItem=k[b-1]};setTimeout(function(){k&&1!=a.pagination.current&&a.isMultipleQuestions&&a.scrollToQuestion(a.pagination.current)},500);a.$on(l.Events.Test.GoToQuestion,function(b,c){a.openQuestion(c.num)});a.$on(l.Events.Pagination.FilterChanges,function(b,c){u=c.type;var d=E(u);if(a.isMultipleQuestions){var e=
[];_.each(d,function(a,b){1==a&&e.push(parseInt(b))});a.pagination.current=e[0];w=e[0];a.pagination.currentIndex=1}if(d[a.pagination.current])a.activeItem=u,D(d,c);else{var f=0;_.each(d,function(a,b){a&&0==f&&(f=parseInt(b))});a.isMultipleQuestions||a.openQuestion(f).then(function(){D(d,c)})}});a.$on(l.Events.Question.QuestionFlagged,function(b,c){var d=c.item;a.pagination.flags[d.Index+1]=d.IsFlagged});a.$on(l.Events.Carousel.ToggleCarousel,function(b,c){a.carouselActive=c&&c.hideCarousel?!1:!a.carouselActive});
a.$on(l.Events.Question.QuestionAttempted,function(b,c){a.pagination.attempteds[c.Index+1]=c.IsAttempted});a.$watch("carousel.currentIndex",function(){a.$parent.isFirstQuestion=1==a.carousel.currentIndex;a.$parent.isLastQuestion=a.carousel.currentIndex==a.carousel.questionCount});a.$watch("carousel.questionCount",function(){a.$parent.isFirstQuestion=1==a.carousel.currentIndex;a.$parent.isLastQuestion=a.carousel.currentIndex==a.carousel.questionCount})}}}}])});