define2("services/testWindowItemFactory services/testWindowSectionFactory services/testWindowHelperService services/testWindowTestStateService services/resourceLoaderService services/testWindowConstants services/testWindowCommonUtils".split(" "),function(){angular.module("mettl").register.service("TestWindowFactory",["$log","$http","$q","$rootScope","TestWindowItem","TestWindowSection","TestWindowHelperService","TestWindowTestStateService","ResourceLoaderService","TestWindowConstants","TestWindowCommonUtils",
function(x,L,z,R,A,B,C,h,M,D,N){function O(b){try{d=angular.fromJson(b.tw),y=angular.fromJson(b.theme)}catch(r){x.error("Error while parsing test window data"+r.message);return}var k={hasLongAnswer:!1,hasFes:!1,hasCodeProject:!1,hasCaseStudy:!1,hasCode:!1,hasSql:!1,hasMcq:!1,hasFitb:!1,hasMca:!1,hasShortAnswer:!1,hasSs:!1,hasTyping:!1,hasFileUpload:!1,hasMsq:!1,hasDiagram:!1,hasRLanguage:!1,hasSnippet:d.HasSnippet,hasMeanStack:!1,hasAudio:!1,hasVideo:!1,setter:function(c){"LONG_ANSWER"==c&&(this.hasLongAnswer=
!0);"CS"==c&&(this.hasCaseStudy=!0);"FES"==c&&(this.hasFes=!0);"CP"==c&&(this.hasCodeProject=!0);"CODE"==c&&(this.hasCode=!0);"SQL"==c&&(this.hasSql=!0);"MCQ"==c&&(this.hasMcq=!0);"FITB"==c&&(this.hasFitb=!0);"MCA"==c&&(this.hasMca=!0);"SHORT_ANSWER"==c&&(this.hasShortAnswer=!0);"SS"==c&&(this.hasSs=!0);"TS"==c&&(this.hasTyping=!0);"FU"==c&&(this.hasFileUpload=!0);"MSQ"==c&&(this.hasMsq=!0);"DIAGRAM"==c&&(this.hasDiagram=!0);"R_LANGUAGE"==c&&(this.hasRLanguage=!0);"MEANSTACK"==c&&(this.hasMeanStack=
!0);"AUDIO"==c&&(this.hasAudio=!0);"VIDEO"==c&&(this.hasVideo=!0)}};angular.forEach(d.QuestionTypes,function(c,b){k.setter(c)});return{testWindowData:d,candidateKey:n,candidateName:d.CandidateName,candidateEmail:d.CandidateEmail,scheduleKey:a.key,ClientID:d.ClientId,CompanyName:a.companyName,CandidateInstanceId:d.CandidateInstanceId,redirectUrl:a.redirectUrl,isApi:a.isApi,isPrivateInviteLink:!!a.candidatePrivateInviteKey,resources:k,theme:y,state:{testState:{isWebProctored:a.isWebProctored||!1,browserName:a.browserName,
browserVersion:a.browserVersion,isAllowCopyPaste:d.UiSettings.IsAllowCopyPaste,visualProctoring:a.visualProctoring||!1,uiSettings:d.UiSettings,isQuestionPreview:d.IsQuestionPreview,isPreview:d.Demo,showResult:d.UiSettings.ShowResultOnTestCompletion,showReport:d.UiSettings.ShowReportLink,fixedSectionOrder:d.UiSettings.FixedSectionOrder,blurLimit:a.blurLimit||0,testAttemptNumber:d.AttemptNumber,blurCount:d.BlurCount||0,CandidateProctoringConsentGiven:d.CandidateProctoringConsentGiven||!1}}}}function u(b,
a,k){x.error("error in test window load call",JSON.stringify(b));a?C.Dialogue.ShowErrorMessage(b||"\x3cdiv\x3eError while loading test data.\x3cbr/\x3e Please click on the below button to \x3cb\x3eclose\x3c/b\x3e your test window and then \x3cb\x3erestart\x3c/b\x3e your test.\x3c/div\x3e",function(c){N.closeWindow()},k||"ERROR OCCURRED!",!1):C.Dialogue.ShowNetworkDisconnectionBeforeST(function(){window.location.reload()})}function P(b,a){b?(h.init(b),w.setFixedClientsForCalculator(),M.preLoadQuestionResources(b.resources,
d.ImageUrls).then(function(){a.resolve(b)},function(b){u(b);a.reject(b)}),a.resolve(b)):(u("Error while parsing test-window data",!0),a.reject("Error while parsing test-window data",!0))}var d,y,l,E,F,v=[],s,n,a,Q=(new Date).getTime(),m,G=[],H={},I="CurrentItem Duration IsTimed ItemCount Order SectionID SectionName SkillTypeId Skill_Type_ID Title Instruction Instructions EnforceQuestionAttempt EnforceTime".split(" "),J="Answers Details Duration FromSkill HasImages IsFromAdvancedSkill IsFromSkill ItemDescription ItemID ItemId Question SectionID SectionIndex SkillClientID Skill_ClientID Status".split(" "),
K,w={init:function(b){a||(a=b,a.ck?(n=a.ck,a.isApi=!0):a.isApi=!1)},setFixedClientsForCalculator:function(b){G=b||[77484,86334,5E4,38581,10499,11222]},load:function(){var b,r=!1;switch(a.mode){case "assessmentPreview":case "createdAssessmentPreview":case "questionPreview":b="/preview-load?k\x3d"+document.getElementById("previewDataKey").value+"\x26c\x3d"+a.clientId+"\x26m\x3d"+a.mode;break;default:b="/test-window-load?c\x3d"+encodeURIComponent(n),r=!0}if(r&&!n)return z.reject({exception:"Invalid candidate key"});
var k=z.defer();b=b+"\x26time\x3d"+Q;L.get(b,{cache:!0}).then(function(b){b=O(b.data);P(b,k)},function(b){var a,r;try{b.data&&(a=window[b.data.msg],r=window[b.data.title])}catch(d){x.error("Error while getting error message")}u(a,!0,r);k.reject(b)});return k.promise},PopulateTestTwContent:function(b,r){var k,c,d;try{l=angular.fromJson(b.twContent),k=angular.fromJson(l.JAssessment),c=angular.fromJson(l.JPartialResponse),d=angular.fromJson(l.JCodeItemDetails)}catch(e){x.error("Error while parsing test window content"+
e.message);r.reject(e);return}l.JAssessment=l.JPartialResponse=l.JCodeItemDetails=void 0;var g=!$.isEmptyObject(c);m=g?c:k;c=!1;l.Assessment.Duration=k.Duration;var h={};if(0<d.length)for(var p=0;p<d.length;p++)h[d[p].ItemID]=d[p];d=l.Assessment;for(p=0;p<d.Sections.length;p++){var q=d.Sections[p],q=B.Merge(m.Sections[p],q),q=B.Decorate(q,{Index:p,IsTimed:0!==q.Duration&&1<m.Sections.length});g&&q.TimeTaken==q.Duration&&(c=!0);for(var n=0;n<q.Items.length;n++){var t=q.Items[n],t=A.Merge(m.Sections[p].Items[n],
t),t=A.Decorate(t,{Index:n,SectionIndex:p,SectionID:q.SectionID});t.ItemID in h&&t.Prepare(h[t.ItemID],t,g)}}k=k.CandidateBehaviour;v=l.Assessment.Sections;s=l.Assessment;g&&(v[m.CurrentSection].CurrentItem=v[m.CurrentSection].Items[m.CurrentItem]);h=parseInt(w.sections.selectedSectionIndex)||0;0<h&&(m.CurrentSection=h,m.CurrentItem=0);var u;w.test.isTaskBasedAssessment()&&(u=parseInt(b.taskBasedDuration,10));return{testWindowContent:l,IsTestPaused:m.IsTestPaused,testTimeForTaskBasedTest:u,state:{currentItemIndex:m.CurrentItem||
0,currentSectionIndex:m.CurrentSection||0,testState:{isTestProctorPaused:a.visualProctoring?m.IsTestPaused||!1:!1,isPowerResume:g,isPractiseTest:l.IsPracticeTest,isSectionTimeOverAndResumed:c,blurCount:k.BlurCount,SnapsTaken:k?k.SnapsTaken:0}}}},handlePostLoadContent:function(b,a){b?(E=b,h.initTestContent(b),w.test.setDuration(b.testTimeForTaskBasedTest)):(u("Error while parsing test-window content",!0),a.reject("Error while parsing test-window content",!0))},get:function(){return d},getThemeObj:function(){return y},
getTestWindowContent:function(){return l},returnTwContent:function(){return E},test:{getAssessmentId:function(){return s.AssessmentID},getAssessmentLanguage:function(){return s.Language.Language},getClientId:function(){return s&&s.ClientId||a&&a.clientId||""},getDuration:function(){return K||s.Duration},getCandidateInstanceId:function(){return d?d.CandidateInstanceId:-1},getCandidateEmail:function(){return d&&d.CandidateEmail||a&&a.candidateEmailId||""},getInvitationKey:function(){return a&&a.key},
getShowReportLink:function(){return s.UiSettings.ShowReportLink},getShowResult:function(){return s.UiSettings.ShowResultOnTestCompletion},isFixedSectionOrder:function(){return s.UiSettings.FixedSectionOrder},hasSlowGrading:function(){return d.HasSlowGrading},getCandidateKey:function(){return n},setCandidateKey:function(b){n=b},getTestName:function(){return a.testName},isPreview:function(){return"test"!=a.mode},isApi:function(){return a.isApi},isPrivateInviteLink:function(){return!!a.candidatePrivateInviteKey},
redirectUrl:function(){return a.redirectUrl},isMSB:function(){return a.browserLock||!1},getBrowserName:function(){return a&&a.browserName||""},getBrowserVersion:function(){return a&&a.browserVersion||""},getOsName:function(){return a&&a.os||""},getOsBit:function(){return a&&a.osBit||""},getCompanyName:function(){return a&&a.companyName||""},updateMpsCandidateInfo:function(b){angular.forEach(b,function(b,a){H[a]=b})},getMpsCandidateInfo:function(){return H},isTaskBasedAssessment:function(){return a.isTaskBasedTest},
setDuration:function(b){K=b},getCiaId:function(){return d.CiaId}},sections:{getByIndex:function(b){return v[parseInt(b,10)]},count:function(){return v.length},getAll:function(){return v},setSectionsInfo:function(b){F=b},getSectionsInfo:function(){return F},selectedSectionIndex:void 0},getOptimizedJsonData:function(b,a,d){b=b||h.PRSource;for(var c=[],c=JSON.stringify(this.sections.getAll()),c=JSON.parse(c),f=0;f<c.length;f++)for(var e=0;e<c[f].Items.length;e++){var g=c[f].Items[e];g.Question=void 0;
g.NodeMap=void 0;g.CodeQuestionState=void 0;g.questionImages=void 0;g.uiPositions=void 0}g=[];angular.copy(c,g);for(f=0;f<g.length;f++){e=g[f];for(c=0;c<I.length;c++)delete e[I[c]];for(e=0;e<g[f].Items.length;e++){var l=g[f].Items[e];if(!d)for(c=0;c<J.length;c++)delete l[J[c]]}}return{candidateInstanceId:this.test.getCandidateInstanceId(),candidateKey:this.test.getCandidateKey(),time:(new Date).toString(),currentSection:h.sectionState.currentIndex,currentItem:h.itemState.currentIndex,isTestPaused:h.testState.isTestProctorPaused,
testTimeLeft:a,sections:angular.toJson(g),source:window.mad?"DRR":"Browser",prSource:b,isClosed:h.testState.crossClickAttempted,attemptNumber:h.testState.testAttemptNumber,mode:h.testState.testEndingMode,aId:this.test.getAssessmentId(),hasSlowGrading:this.test.hasSlowGrading()}},getSTData:function(){var b=h.testState,a;1==this.get().AttemptNumber&&(a=this.sections.selectedSectionIndex||0);return{b:JSON.stringify({CIID:this.test.getCandidateInstanceId(),IsWebProctored:b.isWebProctored,BlurCount:b.blurCount,
BlurLimit:b.blurLimit,CameraInactive:b.cameraInactive,CameraDialogueShowing:b.cameraDialogueShowing,CrossClickAttempted:b.crossClickAttempted,AssessmentCodingLanguages:b.uiSettings.AssessmentCodingLanguages,CandidateProctoringConsentGiven:b.CandidateProctoringConsentGiven,pid:this.test.getMpsCandidateInfo()?this.test.getMpsCandidateInfo().id:null}),t:(new Date).toString(),source:window.mad?"DRR":"Browser",prs:b.isPowerResume?D.PR_SOURCE.POWER_RESUME:D.PR_SOURCE.START_TEST,selectedSectionIndex:a,currentTimeZone:moment.tz.guess(),
ciaId:this.test.getCiaId()}},getAttemptSummary:function(){for(var b=this.sections.getAll(),a={total:{questionAttempted:0,questionUnattempted:0,marked:0},sectionData:[]},d=0,c=0;c<b.length;c++){var f=b[c],e={questionAttempted:f.GetAttemptedCount(),questionUnattempted:f.GetUnAttemptedCount(),marked:f.GetMarkedForReviewCount()},d=e.questionAttempted+e.marked+e.questionUnattempted;e.attemptedWidth=e.questionAttempted/d*90;e.markedWidth=e.marked/d*90;e.unattemptedWidth=e.questionUnattempted/d*90;a.total.questionAttempted+=
e.questionAttempted;a.total.marked+=e.marked;a.total.questionUnattempted+=e.questionUnattempted;a.sectionData.push({qCount:f.Items.length,canBeNavigatedTo:!f.IsTimed||!f.IsComplete(),sectionName:f.SectionName,questions:e})}d=a.total.questionAttempted+a.total.marked+a.total.questionUnattempted;a.total.attemptedWidth=a.total.questionAttempted/d*90;a.total.markedWidth=a.total.marked/d*90;a.total.unattemptedWidth=a.total.questionUnattempted/d*90;return a},isAllowedNewCalculator:function(){return-1!=G.indexOf(a.clientId)}};
return w}])});